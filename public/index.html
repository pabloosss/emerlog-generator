<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Generator PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
    }
    h1 { text-align: center; }
    input, button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
    #output {
      background: white;
      padding: 20px;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td, th {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }
    #sendPDF {
      background-color: green;
      color: white;
      border: none;
    }
  </style>
</head>
<body>

  <h1>Generator Harmonogramu</h1>
  <label>Imię i nazwisko:</label>
  <input type="text" id="name" placeholder="Jan Kowalski" />
  <label>Liczba godzin:</label>
  <input type="number" id="hours" min="1" placeholder="Np. 80" />
  <button onclick="generateTable()">Generuj tabelę</button>

  <div id="output"></div>
  <button id="sendPDF" style="display:none;">Wyślij tabelę e-mailem</button>

  <script>
    async function generateTable() {
      const name = document.getElementById("name").value.trim();
      const hours = parseInt(document.getElementById("hours").value);
      if (!name || isNaN(hours)) {
        alert("Uzupełnij dane");
        return;
      }

      const days = Math.ceil(hours / 8);
      let remaining = hours;
      let html = `<h2>Harmonogram - ${name}</h2>`;
      html += `<table><tr><th>Dzień</th><th>Liczba godzin</th></tr>`;
      for (let i = 1; i <= days; i++) {
        const h = Math.min(8, remaining);
        html += `<tr><td>${i}</td><td>${h}</td></tr>`;
        remaining -= h;
      }
      html += `<tr><th>Suma</th><th>${hours}</th></tr></table>`;
      document.getElementById("output").innerHTML = html;
      document.getElementById("sendPDF").style.display = "inline-block";
    }

    document.getElementById("sendPDF").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const name = document.getElementById("name").value.trim();
      const output = document.getElementById("output");
      if (!name || !output.innerHTML.trim()) {
        return alert("Najpierw wygeneruj tabelę");
      }

      const canvas = await html2canvas(output, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "pt", "a4");
      pdf.addImage(imgData, "PNG", 20, 20, 555, 0);
      const pdfBase64 = pdf.output("datauristring").split(",")[1];

      try {
        const res = await fetch("/send-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, pdfData: pdfBase64 })
        });
        const data = await res.json();
        if (res.ok) {
          alert("PDF wysłany na maila!");
        } else {
          alert("Błąd wysyłania: " + data.error);
        }
      } catch (err) {
        console.error("Błąd wysyłki PDF:", err);
        alert("Nie udało się wysłać PDF");
      }
    });
  </script>

</body>
</html>
