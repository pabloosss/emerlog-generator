<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <title>Generator Godzin Rmsped - Word-like Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f9f9f9;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    .container {
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 1000px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #333;
    }
    .header p {
      font-size: 16px;
      color: #555;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    .card h5 {
      margin-bottom: 15px;
      font-weight: 600;
    }
    .instructions ul {
      list-style: none;
      padding-left: 0;
    }
    .instructions ul li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 25px;
    }
    .instructions ul li::before {
      content: "\f058";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      color: #0066cc;
      position: absolute;
      left: 0;
      top: -1px;
    }
    .form-group.required .form-label:after {
      content: "*";
      color: red;
      margin-left: 5px;
    }
    .form-text {
      font-size: 12px;
      color: #666;
    }
    .holidays-list li {
      margin-bottom: 5px;
    }
    .btn {
      transition: background-color 0.3s ease;
    }
    footer {
      margin-top: 40px;
      text-align: center;
      color: #777;
      font-size: 0.85em;
    }
    /* Stylizacja tabeli */
    .final-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .final-table th,
    .final-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    .final-table thead th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    .final-table .holiday td {
      background-color: #ffcccc;
      color: #a00;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Nagłówek -->
  <div class="header">
    <h1><i class="fas fa-clock"></i> Generator Godzin Rmsped</h1>
    <p>Wprowadź dane i wybierz rodzaj umowy.</p>
  </div>

  <!-- Instrukcja -->
  <div class="card mb-4">
    <h5><i class="fas fa-info-circle"></i> Instrukcja</h5>
    <div class="instructions">
      <ul>
        <li>Wybierz rodzaj umowy:
          <ul>
            <li><strong>Umowa zlecenie</strong> – godziny generowane losowo, <em>opcja "Losowe dni wolne" jest obowiązkowa</em>.</li>
            <li><strong>Umowa o pracę (pełny etat)</strong> – stałe godziny: 8:00–16:00.</li>
            <li><strong>Umowa o pracę (3/4 etatu)</strong> – stałe godziny: 8:00–14:00.</li>
          </ul>
        </li>
        <li>Dla umowy zlecenie wpisz łączną liczbę godzin – dla umów o pracę to pole jest ukryte.</li>
        <li>Wybierz miesiąc i rok oraz (opcjonalnie) dodaj ręcznie dni wolne – z podaniem rodzaju (np. wypoczynkowy, L4).</li>
        <li>Opcja „Dodaj losowo dni wolne”:
          <ul>
            <li><em>Obowiązkowa</em> przy umowie zleceniu (zaznaczona na stałe).</li>
            <li><em>Dobrowolna</em> przy umowie o pracę.</li>
          </ul>
        </li>
        <li>Kliknij „Generuj tabelę” i pobierz PDF.</li>
      </ul>
    </div>
  </div>

  <!-- Formularz -->
  <div class="card mb-4">
    <form id="generatorForm" novalidate>
      <!-- Wybór rodzaju umowy -->
      <div class="mb-3">
        <label class="form-label">Rodzaj umowy</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contractZlecenie" value="zlecenie" checked />
          <label class="form-check-label" for="contractZlecenie">Umowa zlecenie</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contractPraca" value="praca" />
          <label class="form-check-label" for="contractPraca">Umowa o pracę (pełny etat)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contract34" value="praca3/4" />
          <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3 form-group required">
          <label class="form-label" for="name">Imię i nazwisko</label>
          <input class="form-control" type="text" id="name" required />
          <div class="invalid-feedback">Wpisz imię i nazwisko.</div>
        </div>
        <!-- Pole "Łączna liczba godzin" – widoczne tylko przy umowie zlecenie -->
        <div class="col-md-6 mb-3 form-group required" id="hoursGroup">
          <label class="form-label" for="hours">Łączna liczba godzin</label>
          <input class="form-control" type="number" id="hours" min="1" required />
          <div class="invalid-feedback">Wpisz liczbę godzin (min 1).</div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3 form-group required">
          <label class="form-label" for="month">Miesiąc</label>
          <select class="form-select" id="month" required>
            <option value="">Wybierz...</option>
            <option value="1">Styczeń</option>
            <option value="2">Luty</option>
            <option value="3">Marzec</option>
            <option value="4">Kwiecień</option>
            <option value="5">Maj</option>
            <option value="6">Czerwiec</option>
            <option value="7">Lipiec</option>
            <option value="8">Sierpień</option>
            <option value="9">Wrzesień</option>
            <option value="10">Październik</option>
            <option value="11">Listopad</option>
            <option value="12">Grudzień</option>
          </select>
          <div class="invalid-feedback">Wybierz miesiąc.</div>
        </div>
        <div class="col-md-4 mb-3 form-group required">
          <label class="form-label" for="year">Rok</label>
          <input class="form-control" type="number" id="year" min="1900" value="2025" required />
          <div class="invalid-feedback">Podaj rok (np. 2025).</div>
        </div>
        <div class="col-md-4 mb-3">
          <small class="form-text">Praca kończy się zawsze przed 20:00.</small>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Dodatkowe dni wolne</label>
        <div class="row g-2">
          <div class="col">
            <input class="form-control" type="date" id="holidayPicker" />
          </div>
          <div class="col">
            <select class="form-select" id="holidayTypeSelect">
              <option value="Urlop wypoczynkowy">Urlop wypoczynkowy</option>
              <option value="Urlop okolicznościowy">Urlop okolicznościowy</option>
              <option value="Zwolnienie lekarskie (L4)">Zwolnienie lekarskie (L4)</option>
              <option value="Bezpłatny">Urlop bezpłatny</option>
              <option value="Inne">Inne</option>
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-secondary" type="button" id="addHoliday">Dodaj wolne</button>
          </div>
        </div>
        <ul class="holidays-list mt-2" id="holidaysList"></ul>
      </div>

      <div class="mb-3 form-check" id="randomHolidaysGroup">
        <input class="form-check-input" type="checkbox" id="randomHolidays" />
        <label class="form-check-label" for="randomHolidays">Dodaj losowo dni wolne</label>
      </div>

      <button class="btn btn-primary" type="submit">Generuj tabelę</button>
    </form>
  </div>

  <div class="table-responsive" id="output"></div>

  <div class="mt-3" id="exportButtons" style="display:none;">
    <button class="btn btn-success" id="generatePDF"><i class="far fa-file-pdf"></i> Pobierz jako PDF</button>
    <button class="btn btn-primary mt-2" id="sendPDFEmail">Wyślij tabelę e-mailem</button>
  </div>

  <div class="text-center mt-4">
    <a href="admin.html" class="btn btn-outline-dark">
      <i class="fas fa-user-shield"></i> Panel Administratora
    </a>
  </div>
</div>

<footer>© 2023 Emerlog</footer>

<!-- Biblioteki JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
console.log("Skrypt startuje - sprawdź, czy są jakieś błędy w konsoli.");

// (Cała logika: generowanie tabeli, PDF, itp.)
/*
  - Upewnij się, że wypełniasz wszystkie pola:
    * Imię i nazwisko
    * Miesiąc
    * Rok
    * Godziny (jeśli zlecenie)
*/

/////////////////////////////////////////////////////////////////////////
// Poniżej wklejamy kod generujący tabelę i PDF, z scale: 0.3 w html2canvas
/////////////////////////////////////////////////////////////////////////

// Stałe, np. MAX_HOURS...
const MAX_HOURS_PER_DAY = 12;
const MIN_HOURS_PER_DAY = 4;

// Tablice globalne
window.customHolidays = [];
window.randomFreeDaysAdded = [];

document.addEventListener("DOMContentLoaded", () => {
  console.log("DOMContentLoaded fired");

  // Zmiana rodzaju umowy
  document.querySelectorAll('input[name="contractType"]').forEach(rad => {
    rad.addEventListener("change", onContractChange);
  });

  // Submit
  const form = document.getElementById("generatorForm");
  form.addEventListener("submit", e => {
    e.preventDefault();
    console.log("Klik: Generuj tabelę - sprawdzamy validację...");
    if(!form.checkValidity()){
      console.log("Formularz nie jest poprawnie wypełniony.");
      e.stopPropagation();
    } else {
      console.log("Formularz OK, wywołujemy generateTable()");
      generateTable();
    }
    form.classList.add("was-validated");
  });

  // Dodawanie dni wolnych
  document.getElementById("addHoliday").addEventListener("click", () => {
    const selDate = document.getElementById("holidayPicker").value;
    const holidayType = document.getElementById("holidayTypeSelect").value;
    if(!selDate){
      alert("Wybierz datę!");
      return;
    }
    if(!window.customHolidays.find(x => x.date===selDate)){
      window.customHolidays.push({ date: selDate, type: holidayType });
    } else {
      alert("Ten dzień jest już dodany jako wolny!");
    }
    renderHolidays();
  });

  onContractChange();
  document.getElementById("month").addEventListener("change", updateHolidayPickerRange);
  document.getElementById("year").addEventListener("change", updateHolidayPickerRange);
});

function onContractChange(){
  const type = document.querySelector('input[name="contractType"]:checked').value;
  console.log("onContractChange =>", type);

  const randomH = document.getElementById("randomHolidays");
  const hoursGroup = document.getElementById("hoursGroup");
  const hoursInput = document.getElementById("hours");
  const holidayTypeSelect = document.getElementById("holidayTypeSelect");

  if(type==="zlecenie"){
    // Pokaż pole hours
    hoursGroup.style.display="block";
    hoursInput.required=true;

    randomH.checked=true;
    randomH.disabled=true;

    // Tylko L4
    holidayTypeSelect.innerHTML="";
    const opt=document.createElement("option");
    opt.value="Zwolnienie lekarskie (L4)";
    opt.textContent="Zwolnienie lekarskie (L4)";
    holidayTypeSelect.appendChild(opt);

  }else{
    // praca
    hoursGroup.style.display="none";
    hoursInput.required=false;

    randomH.checked=false;
    randomH.disabled=false;

    // Wiele opcji
    holidayTypeSelect.innerHTML="";
    const ops=[
      "Urlop wypoczynkowy",
      "Urlop okolicznościowy",
      "Zwolnienie lekarskie (L4)",
      "Bezpłatny",
      "Inne"
    ];
    ops.forEach(o=>{
      const opt=document.createElement("option");
      opt.value=o;
      opt.textContent=o;
      holidayTypeSelect.appendChild(opt);
    });
  }
}

function renderHolidays(){
  const ul=document.getElementById("holidaysList");
  ul.innerHTML="";
  window.customHolidays.forEach(item=>{
    const li=document.createElement("li");
    li.textContent=`${item.date} – ${item.type}`;
    const btn=document.createElement("button");
    btn.textContent="Usuń";
    btn.classList.add("btn","btn-sm","btn-danger","ms-2");
    btn.addEventListener("click", ()=>{
      window.customHolidays=window.customHolidays.filter(x=>x!==item);
      renderHolidays();
    });
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

function updateHolidayPickerRange(){
  const mVal=parseInt(document.getElementById("month").value,10);
  const yVal=parseInt(document.getElementById("year").value,10);
  const holidayPicker=document.getElementById("holidayPicker");
  if(!mVal||!yVal){
    holidayPicker.removeAttribute("min");
    holidayPicker.removeAttribute("max");
    return;
  }
  const daysInMonth=new Date(yVal,mVal,0).getDate();
  const mm=String(mVal).padStart(2,'0');
  const minDate=`${yVal}-${mm}-01`;
  const maxDate=`${yVal}-${mm}-${daysInMonth}`;
  holidayPicker.setAttribute("min",minDate);
  holidayPicker.setAttribute("max",maxDate);

  if(holidayPicker.value && (holidayPicker.value<minDate||holidayPicker.value>maxDate)){
    holidayPicker.value="";
  }
}

// Przykładowe stałe świąt
const fixedHolidays=[
  "01-01","06-01","20-04","21-04","01-05","03-05","08-06","19-06",
  "15-08","01-11","11-11","25-12","26-12"
];
function checkCustomHoliday(day,month,year){
  const dd=String(day).padStart(2,'0');
  const mm=String(month).padStart(2,'0');
  const yyyy=String(year).padStart(4,'0');
  const fullDate=`${yyyy}-${mm}-${dd}`;
  return window.customHolidays.find(x=>x.date===fullDate)||null;
}
function isFixedHoliday(day,month){
  const dd=String(day).padStart(2,'0');
  const mm=String(month).padStart(2,'0');
  return fixedHolidays.includes(`${dd}-${mm}`);
}
function isWeekend(dObj){
  const dw=dObj.getDay();
  return (dw===0||dw===6);
}
function shuffleArray(ar){
  for(let i=ar.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [ar[i],ar[j]]=[ar[j],ar[i]];
  }
}
function distributeHours(totalHours,daysCount){
  console.log("distributeHours => totalHours:",totalHours,", daysCount:",daysCount);
  if(!daysCount)return null;
  const maxPos=MAX_HOURS_PER_DAY*daysCount;
  const minPos=MIN_HOURS_PER_DAY*daysCount;
  if(totalHours>maxPos){
    alert(`Za dużo godzin (max ${maxPos})!`);
    return null;
  }
  if(totalHours<minPos){
    alert(`Za mało godzin (min ${minPos})!`);
    return null;
  }
  let arr=new Array(daysCount).fill(MIN_HOURS_PER_DAY);
  let leftover=totalHours-(daysCount*MIN_HOURS_PER_DAY);
  let base=Math.floor(leftover/daysCount);
  let rem=leftover%daysCount;
  for(let i=0;i<daysCount;i++){
    arr[i]+=base;
  }
  let idx=[...Array(daysCount).keys()];
  shuffleArray(idx);
  for(let i=0;i<rem;i++){
    for(let j=0;j<daysCount;j++){
      if(arr[idx[j]]<MAX_HOURS_PER_DAY){
        arr[idx[j]]++;
        break;
      }
    }
  }
  let diff=totalHours-arr.reduce((a,b)=>a+b,0);
  if(diff!==0){
    for(let i=0;i<daysCount && diff!==0;i++){
      if(diff>0 && arr[i]<MAX_HOURS_PER_DAY){
        let canAdd=Math.min(diff,MAX_HOURS_PER_DAY-arr[i]);
        arr[i]+=canAdd; diff-=canAdd;
      }else if(diff<0 && arr[i]>MIN_HOURS_PER_DAY){
        let canRem=Math.min(Math.abs(diff),arr[i]-MIN_HOURS_PER_DAY);
        arr[i]-=canRem; diff+=canRem;
      }
    }
  }
  let finalSum=arr.reduce((a,b)=>a+b,0);
  if(finalSum!==totalHours){
    alert("Nie udało się dopasować godzin do wskazanej sumy.");
    return null;
  }
  return arr;
}
function getRandomInt(mi,ma){
  mi=Math.ceil(mi);
  ma=Math.floor(ma);
  return (ma<mi)?mi:Math.floor(Math.random()*(ma-mi+1))+mi;
}

function generateTable(){
  console.log("generateTable() fired");
  window.randomFreeDaysAdded=[];

  const fullName=document.getElementById("name").value.trim();
  const monthVal=parseInt(document.getElementById("month").value,10);
  const yearVal=parseInt(document.getElementById("year").value,10);
  const addRandom=document.getElementById("randomHolidays").checked;
  const contractType=document.querySelector('input[name="contractType"]:checked').value;

  if(!fullName||!monthVal||!yearVal){
    alert("Proszę wypełnić wszystkie wymagane pola!");
    return;
  }

  console.log("Stworzymy dane dayData...");

  const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec",
                    "Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
  const daysInMonth=new Date(yearVal,monthVal,0).getDate();
  let dayData=[];

  for(let d=1; d<=daysInMonth; d++){
    const dateObj=new Date(yearVal,monthVal-1,d);
    const cHol=checkCustomHoliday(d,monthVal,yearVal);
    const weekend=isWeekend(dateObj);
    const fixHol=isFixedHoliday(d,monthVal);

    let holType="";
    if(cHol){
      holType=cHol.type;
    }else if(fixHol){
      holType="Święto";
    }
    const isWork=(!weekend && !fixHol && !cHol);
    dayData.push({
      day:d,
      date:dateObj,
      isWorkingDay:isWork,
      holidayType:holType,
      hours:0,
      start:"-",
      end:"-"
    });
  }

  // losowe zlecenie
  if(contractType==="zlecenie" && addRandom){
    console.log("dodajemy losowe wolne (zlecenie)...");
    const pattern=[0,1,3,1,0,0];
    let grouped={};
    dayData.forEach(it=>{
      const week=Math.floor((it.day-1)/7)+1;
      if(!grouped[week]) grouped[week]=[];
      grouped[week].push(it);
    });
    Object.keys(grouped).forEach(k=>{
      const arr=grouped[k].filter(x=>x.isWorkingDay);
      let need=pattern[parseInt(k)-1]||0;
      need=Math.min(need,arr.length);
      if(need>0){
        arr.sort(()=>0.5-Math.random());
        arr.slice(0,need).forEach(dd=>{
          dd.isWorkingDay=false;
          dd.holidayType="Losowy dzień wolny";
          window.randomFreeDaysAdded.push(dd);
        });
      }
    });
  }

  let workingDays=dayData.filter(x=>x.isWorkingDay);
  let totalHours=0;

  if(contractType==="praca"){
    workingDays.forEach(d=>{
      d.hours=8; d.start="8:00"; d.end="16:00";
    });
    totalHours=workingDays.length*8;
  }else if(contractType==="praca3/4"){
    workingDays.forEach(d=>{
      d.hours=6; d.start="8:00"; d.end="14:00";
    });
    totalHours=workingDays.length*6;
  }else if(contractType==="zlecenie"){
    totalHours=parseInt(document.getElementById("hours").value,10);
    const hoursArr=distributeHours(totalHours,workingDays.length);
    if(!hoursArr)return;
    for(let i=0; i<workingDays.length; i++){
      let wd=workingDays[i];
      wd.hours=hoursArr[i];
      let maxStart=20-hoursArr[i];
      let sH=getRandomInt(6,maxStart);
      let eH=sH+hoursArr[i];
      if(eH>20){
        alert(`Dzień ${wd.day}: koniec pracy po 20:00!`);
        return;
      }
      wd.start=sH+":00";
      wd.end=eH+":00";
    }
    let sumCheck=workingDays.reduce((a,b)=>a+b.hours,0);
    if(sumCheck!==totalHours){
      alert(`Finalna suma godzin to ${sumCheck}, a zadano ${totalHours}. Spróbuj mniejszą liczbę godzin.`);
      return;
    }
  }

  // generujemy HTML
  console.log("generujemy tabele HTML...");
  const nameParts=fullName.split(/\s+/);
  const lastName=nameParts.slice(1).join(" ");
  const rows=dayData.map(inf=>{
    const dd=String(inf.day).padStart(2,'0');
    const mm=String(monthVal).padStart(2,'0');
    const yyyy=yearVal;
    const wkd=inf.date.toLocaleString('pl-PL',{weekday:'short'});
    if(inf.isWorkingDay && inf.hours>0){
      return `<tr>
        <td>${inf.day}</td>
        <td>${dd}.${mm}.${yyyy} (${wkd})</td>
        <td>${inf.start}</td>
        <td>${inf.end}</td>
        <td>${inf.hours}</td>
        <td>${lastName}</td>
        <td></td>
        <td>-</td>
      </tr>`;
    }else{
      return `<tr class="holiday">
        <td>${inf.day}</td>
        <td>${dd}.${mm}.${yyyy} (${wkd})</td>
        <td>-</td>
        <td>-</td>
        <td>0</td>
        <td>${lastName}</td>
        <td></td>
        <td>${inf.holidayType||"-"}</td>
      </tr>`;
    }
  });
  const sumOfHours=workingDays.reduce((a,b)=>a+b.hours,0);
  rows.push(`
    <tr class="fw-bold">
      <td colspan="4">Suma godzin:</td>
      <td>${sumOfHours}</td>
      <td colspan="3"></td>
    </tr>
  `);

  const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec",
                    "Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
  const tableHTML=`
    <h3 class="mt-4">${monthNames[monthVal-1]} ${yearVal}</h3>
    <h4>${fullName}</h4>
    <p><strong>Rodzaj umowy: ${
      contractType==="praca" ? "Umowa o pracę (8:00 - 16:00)"
      : contractType==="praca3/4" ? "Umowa o pracę (3/4 etatu, 8:00 - 14:00)"
      : "Umowa zlecenie"
    }</strong></p>
    <table class="final-table">
      <thead>
        <tr>
          <th>Dzień</th>
          <th>Data</th>
          <th>Godz. rozpoczęcia</th>
          <th>Godz. zakończenia</th>
          <th>Suma godzin</th>
          <th>Podpis zleceniobiorcy</th>
          <th>Podpis zleceniodawcy</th>
          <th>Rodzaj wolnego</th>
        </tr>
      </thead>
      <tbody>
        ${rows.join("")}
      </tbody>
    </table>
  `;
  document.getElementById("output").innerHTML=tableHTML;
  document.getElementById("exportButtons").style.display="block";

  // PDF
  document.getElementById("generatePDF").onclick=downloadPDF;
}

async function downloadPDF(){
  console.log("downloadPDF() start - scale=0.3 w html2canvas");
  try{
    const { jsPDF }=window.jspdf;
    const pdf=new jsPDF("portrait","pt","a4");
    const pageWidth=pdf.internal.pageSize.getWidth();
    const pageHeight=pdf.internal.pageSize.getHeight();
    const margin=20;

    const logoURL="https://lh3.googleusercontent.com/p/AF1QipMLjr7Z89mLaqKXBwtbab8UDG53ccbcEWvGqlpL=s1360-w1360-h1020";
    const logoImg=new Image();
    logoImg.crossOrigin="Anonymous";
    logoImg.src=logoURL;
    await new Promise(resolve=>{logoImg.onload=resolve;});

    const desiredLogoWidth=150;
    let desiredLogoHeight=logoImg.height*(desiredLogoWidth/logoImg.width);
    if(!desiredLogoHeight||desiredLogoHeight<=0||Number.isNaN(desiredLogoHeight)) desiredLogoHeight=50;
    pdf.addImage(logoImg,"PNG",margin,margin,desiredLogoWidth,desiredLogoHeight);

    const outputEl=document.getElementById("output");
    if(!outputEl){
      alert("Brak elementu #output do wygenerowania PDF.");
      return;
    }

    // **Tu używamy scale=0.3** - całość jest przechwytywana, ale w niskiej rozdzielczości
    const canvas=await html2canvas(outputEl,{
      scale:0.3,
      useCORS:true,
      allowTaint:false
    });
    console.log("canvas width:",canvas.width,"height:",canvas.height);

    const tableImg=canvas.toDataURL("image/png");

    const gap=0;
    const availableH=pageHeight-(margin+desiredLogoHeight+gap+margin);
    const availableW=pageWidth-2*margin;
    const ratio=Math.min(availableW/canvas.width, availableH/canvas.height);
    let finalW=canvas.width*ratio;
    let finalH=canvas.height*ratio;
    if(!finalW||finalW<=0||Number.isNaN(finalW)) finalW=canvas.width;
    if(!finalH||finalH<=0||Number.isNaN(finalH)) finalH=canvas.height;

    let posX=(pageWidth-finalW)/2;
    let posY=margin+desiredLogoHeight+gap+(availableH-finalH)/2;
    posX=Math.max(posX,margin);
    posY=Math.max(posY,margin+desiredLogoHeight+gap);

    pdf.addImage(tableImg,"PNG",posX,posY,finalW,finalH);
    pdf.save("Tabela_Godzinowa_Pion.pdf");
    console.log("PDF gotowy, scale=0.3");
  }catch(err){
    console.error("Błąd generowania PDF:",err);
    alert("Wystąpił błąd przy generowaniu PDF. Zobacz konsolę.");
  }
}

document.getElementById("sendPDFEmail").addEventListener("click",async()=>{
  console.log("sendPDFEmail() start - scale=0.3 w html2canvas");
  const name=document.getElementById("name").value.trim();
  if(!name){
    alert("Podaj imię i nazwisko, zanim wyślesz e-mailem!");
    return;
  }

  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF("portrait","pt","a4");

  const outputEl=document.getElementById("output");
  if(!outputEl){
    alert("Najpierw wygeneruj tabelę!");
    return;
  }

  const canvas=await html2canvas(outputEl,{
    scale:0.3,
    useCORS:true,
    allowTaint:false
  });

  const imgData=canvas.toDataURL("image/png");
  const pageW=pdf.internal.pageSize.getWidth();
  const pageH=pdf.internal.pageSize.getHeight();
  const margin=20;

  const ratio=Math.min((pageW-2*margin)/canvas.width,(pageH-2*margin)/canvas.height);
  let finalW=canvas.width*ratio;
  let finalH=canvas.height*ratio;
  let posX=(pageW-finalW)/2;
  let posY=margin;
  pdf.addImage(imgData,"PNG",posX,posY,finalW,finalH);

  const pdfBlob=pdf.output("blob");
  const reader=new FileReader();
  reader.onloadend=async()=>{
    const base64=reader.result.split(",")[1];
    try{
      const resp=await fetch("/send-pdf",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ name, pdfData: base64 })
      });
      if(resp.ok){
        alert("PDF został wysłany e-mailem!");
      }else{
        alert("Błąd przy wysyłaniu PDF.");
      }
    }catch(e){
      console.error("Błąd fetch /send-pdf",e);
      alert("Nie udało się wysłać PDF. Sprawdź konsolę.");
    }
  };
  reader.readAsDataURL(pdfBlob);
});
</script>
</body>
</html>
