<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generator Godzin Rmsped</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
    .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    h1 { text-align: center; }
    input, select, button { margin: 10px 0; padding: 8px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    #output { margin-top: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Generator Harmonogramu</h1>
    <label>Imię i nazwisko:</label>
    <input type="text" id="name" placeholder="Jan Kowalski" />
    <label>Miesiąc:</label>
    <select id="month">
      <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
      <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
      <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
      <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
    </select>
    <label>Rok:</label>
    <input type="number" id="year" value="2025" />
    <button onclick="generateAndSend()">Generuj i wyślij e-mailem</button>

    <div id="output"></div>
  </div>

  <script>
    async function generateAndSend() {
      const name = document.getElementById("name").value.trim();
      const month = parseInt(document.getElementById("month").value);
      const year = parseInt(document.getElementById("year").value);

      if (!name || isNaN(month) || isNaN(year)) {
        alert("Uzupełnij wszystkie pola.");
        return;
      }

      const date = new Date(year, month - 1, 1);
      const tableRows = [];
      let workDays = 0;

      while (date.getMonth() === month - 1) {
        const day = date.getDate();
        const weekday = date.getDay(); // 0 = niedziela, 6 = sobota
        if (weekday !== 0 && weekday !== 6) {
          workDays++;
          tableRows.push(`<tr><td>${day}.${month}.${year}</td><td>08:00 - 16:00</td><td>8</td><td>${name}</td></tr>`);
        }
        date.setDate(day + 1);
      }

      const tableHTML = `
        <h2>Harmonogram pracy: ${name}</h2>
        <table>
          <thead>
            <tr><th>Dzień</th><th>Godziny pracy</th><th>Liczba godzin</th><th>Podpis zleceniobiorcy</th></tr>
          </thead>
          <tbody>${tableRows.join("")}</tbody>
          <tfoot><tr><th colspan="2">Suma</th><th>${workDays * 8}</th><th></th></tr></tfoot>
        </table>
      `;
      document.getElementById("output").innerHTML = tableHTML;

      // Przechodzimy do tworzenia PDF i wysyłki
      await sendPDF(name);
    }

    async function sendPDF(name) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");

      const output = document.getElementById("output");
      const canvas = await html2canvas(output, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");
      pdf.addImage(imgData, "PNG", 20, 20, 555, 0);
      const base64PDF = pdf.output("datauristring").split(",")[1];

      try {
        const res = await fetch("/send-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, pdfData: base64PDF }),
        });
        const data = await res.json();
        if (res.ok) {
          alert("PDF został wysłany na e-mail!");
        } else {
          alert("Błąd wysyłania: " + data.error);
        }
      } catch (err) {
        console.error("Błąd wysyłki PDF:", err);
        alert("Wystąpił błąd podczas wysyłania PDF.");
      }
    }
  </script>
</body>
</html>
