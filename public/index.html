<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<title>Generator Godzin Emerlog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<style>
:root{--ink:#111;--muted:#555;--grid:#000;--off-bg:#ffcccc;--off-ink:#a00;--thead-bg:#fff;--paper:#fff}
html,body{background:#f5f5f7;color:var(--ink)}
.container{max-width:1040px}
header{background:#fff;border-bottom:1px solid #e5e7eb}
.brand{font-weight:700}
.card{border:1px solid #e5e7eb;border-radius:12px}
.card-header{background:#fff;border-bottom:1px solid #e5e7eb;font-weight:600}
.sheet-wrap{background:var(--paper);border:1px solid var(--grid);border-radius:10px;overflow:hidden}
.sheet-head{padding:16px 18px 8px 18px;border-bottom:1px solid var(--grid)}
.sheet-head .mname{font-size:24px;font-weight:800;margin:0}
.sheet-head .person{font-size:18px;font-weight:700;margin:2px 0 0}
.sheet-head .ctype{font-size:12px;color:var(--muted);margin:0}
.table-times{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--paper)}
.table-times th,.table-times td{border:1px solid var(--grid);padding:8px 10px;text-align:center;vertical-align:middle;background:#fff;font-size:14px}
.table-times thead th{background:var(--thead-bg);font-weight:700}
.table-times .col-day{width:54px}
.table-times .col-date{text-align:left}
.table-times .col-start,.table-times .col-end{width:100px}
.table-times .col-hours{width:90px}
.table-times .col-sign{width:140px}
.table-times .col-leave{width:110px}
.table-times tr.off td{background:var(--off-bg);color:var(--off-ink);font-weight:700}
.table-times tfoot td{font-weight:800;background:#fff}
@media print{body{background:#fff}.card,.sheet-wrap{box-shadow:none}*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>

<body>
<header>
  <div class="container py-3 d-flex justify-content-between align-items-center">
    <div class="brand h5 m-0"><i class="fas fa-clock me-2 text-primary"></i>Generator Godzin Emerlog</div>
  </div>
</header>

<main class="container py-4">
  <section class="card mb-4">
    <div class="card-header py-3 px-4">Parametry</div>
    <div class="card-body p-4">
      <form id="generatorForm" novalidate>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="name">Imię i nazwisko *</label>
            <input class="form-control" id="name" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="month">Miesiąc *</label>
            <select class="form-select" id="month" required>
              <option value="">Wybierz…</option>
              <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
              <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
              <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
              <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label" for="year">Rok *</label>
            <input class="form-control" type="number" id="year" min="2000" value="2025" required>
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">Rodzaj umowy</label>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="zlecenie" checked><label class="form-check-label">Umowa zlecenie</label></div>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="praca"><label class="form-check-label">Umowa o pracę</label></div>
            <div class="form-check"><input class="form-check-input" type="radio" name="contractType" value="praca3/4"><label class="form-check-label">Umowa o pracę (3/4)</label></div>
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-3">
          <div class="col-md-5" id="hoursGroup">
            <label class="form-label" for="hours">Łączna liczba godzin (zlecenie) *</label>
            <input class="form-control" type="number" id="hours" min="30" step="1">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="randomHolidays">
              <label class="form-check-label" for="randomHolidays">Losowe dni wolne (18–25 %)</label>
            </div>
          </div>

          <div class="col-md-7">
            <label class="form-label">Własne dni wolne</label>
            <div class="row g-2">
              <div class="col-md-6"><input class="form-control" type="date" id="holidayPicker"></div>
              <div class="col-md-4">
                <select class="form-select" id="holidayTypeSelect">
                  <option value="-">Wolne</option>
                  <option value="Święto">Święto (ręcznie)</option>
                </select>
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary" type="button" id="addHoliday"><i class="fa fa-plus"></i></button>
              </div>
            </div>
            <ul class="small mt-2" id="holidaysList"></ul>
          </div>
        </div>

        <div class="mt-4 d-flex gap-2 flex-wrap">
          <button class="btn btn-primary" type="submit"><i class="fa fa-table me-1"></i>Generuj tabelę</button>
          <button class="btn btn-success" type="button" id="generatePDF" disabled><i class="fa-regular fa-file-pdf me-1"></i>Pobierz PDF</button>
          <button class="btn btn-info text-white" type="button" id="sendMail" disabled><i class="fa fa-envelope me-1"></i>Wyślij na maila</button>
        </div>
      </form>
    </div>
  </section>

  <section class="sheet-wrap" id="resultWrap" style="display:none;">
    <div class="sheet-head">
      <h2 class="mname" id="mname"></h2>
      <p class="person" id="pname"></p>
      <p class="ctype" id="ctype"></p>
    </div>
    <div id="output"></div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(()=>{const MIN_START=6,MAX_END=20,MIN_H=4,MAX_H=16;
const ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
async function renderToPDFBase64(){
 const jsPDF=window.jspdf.jsPDF,pdf=new jsPDF("portrait","pt","a4");
 const out=document.getElementById("resultWrap");
 const canvas=await html2canvas(out,{scale:1.6,useCORS:true,backgroundColor:"#fff"});
 const pageW=pdf.internal.pageSize.getWidth(),w=pageW-40,h=canvas.height*(w/canvas.width);
 pdf.addImage(canvas.toDataURL("image/png"),"PNG",20,20,w,h);
 return btoa(pdf.output("arraybuffer"));
}
async function sendPDFMail(){
 try{
  const name=document.getElementById("name").value.trim();
  if(!name){alert("Podaj imię i nazwisko.");return;}
  const base64=await renderToPDFBase64();
  const res=await fetch("/send-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,pdfData:base64})});
  const data=await res.json();
  if(data?.ok)alert("✅ PDF wysłany na maila.");else alert("❌ Błąd wysyłki – "+(data?.error||"nieznany"));
 }catch(e){alert("Błąd połączenia z serwerem.");}
}
document.addEventListener("DOMContentLoaded",()=>{
 document.getElementById("sendMail").addEventListener("click",sendPDFMail);
});
})();
</script>
</body>
</html>
