<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Test Generowania i Wysyłania PDF</title>
  <!-- Minimalne style -->
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 30px auto;
      background: #f5f5f5;
      padding: 20px;
    }
    #content {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 15px;
      margin-right: 10px;
      cursor: pointer;
    }
  </style>

  <!-- Biblioteki do generowania PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>Test Generowania i Wysyłania PDF</h2>

  <div id="content">
    <p>Treść dokumentu PDF (dowolna) – sprawdzamy, czy generowanie działa.</p>
    <p>Możesz tu wstawić tekst lub prostą tabelę itd.</p>
  </div>

  <button id="generatePDFBtn">Generuj PDF (lokalnie)</button>
  <button id="sendPDFBtn">Wyślij PDF do /send-pdf</button>

  <script>
    // ==============================================
    // 1. Generowanie PDF w przeglądarce (lokalnie)
    // ==============================================
    document.getElementById("generatePDFBtn").addEventListener("click", async () => {
      try {
        const { jsPDF } = window.jspdf; // z biblioteki
        const pdf = new jsPDF("p", "pt", "a4");
        const contentEl = document.getElementById("content");

        // html2canvas => screenshot elementu
        const canvas = await html2canvas(contentEl, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        // Wstawiamy obraz do PDF (cała strona)
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Obliczamy skalę, by zmieścić w a4
        const ratio = Math.min(
          pageWidth / canvas.width,
          pageHeight / canvas.height
        );
        const finalWidth = canvas.width * ratio;
        const finalHeight = canvas.height * ratio;

        // Pozycja (centrujemy w poziomie)
        const xPos = (pageWidth - finalWidth) / 2;
        const yPos = 20;

        pdf.addImage(imgData, "PNG", xPos, yPos, finalWidth, finalHeight);
        pdf.save("test.pdf");
        alert("PDF wygenerowany lokalnie!");
      } catch (err) {
        console.error("Błąd generowania PDF", err);
        alert("Błąd generowania PDF. Sprawdź konsolę.");
      }
    });

    // ==============================================
    // 2. Wysyłanie PDF (base64) do /send-pdf
    // ==============================================
    document.getElementById("sendPDFBtn").addEventListener("click", async () => {
      try {
        // Znowu generujemy PDF w pamięci, ale tym razem nie zapisujemy, tylko fetch => /send-pdf
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "pt", "a4");
        const contentEl = document.getElementById("content");

        const canvas = await html2canvas(contentEl, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(
          pageWidth / canvas.width,
          pageHeight / canvas.height
        );
        const finalWidth = canvas.width * ratio;
        const finalHeight = canvas.height * ratio;

        const xPos = (pageWidth - finalWidth) / 2;
        const yPos = 20;
        pdf.addImage(imgData, "PNG", xPos, yPos, finalWidth, finalHeight);

        // Otrzymujemy base64 z biblioteki jsPDF:
        const pdfBase64 = pdf.output("datauristring").split(",")[1]; 
        // => "JVBERi0xLjU..." 

        // Wysyłamy do /send-pdf
        // Zakładamy, że serwer jest skonfigurowany do maila
        // w formacie { name, pdfData }
        const name = "TestPDF"; // Możesz zmienić np. na user input
        const res = await fetch("/send-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, pdfData: pdfBase64 })
        });

        if (res.ok) {
          alert("PDF wysłany do /send-pdf!");
        } else {
          alert("Błąd wysyłki PDF. Status: " + res.status);
        }
      } catch (err) {
        console.error("Błąd wysyłki PDF", err);
        alert("Błąd wysyłki PDF. Sprawdź konsolę.");
      }
    });
  </script>
</body>
</html>
