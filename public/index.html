<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Generator Dni Roboczych - Emerlog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- docx (z JSDelivr!) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.umd.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #eee;
      font-weight: bold;
    }
    #buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Generator Dni Roboczych</h1>

  <div class="mb-3">
    <label for="name" class="form-label">Imię i nazwisko:</label>
    <input type="text" id="name" class="form-control" placeholder="Jan Kowalski">
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="month" class="form-label">Miesiąc (1-12):</label>
      <input type="number" id="month" class="form-control" min="1" max="12" placeholder="np. 5">
    </div>
    <div class="col-md-6 mb-3">
      <label for="year" class="form-label">Rok:</label>
      <input type="number" id="year" class="form-control" min="1900" value="2023">
    </div>
  </div>

  <button id="generateBtn" class="btn btn-primary mb-3">Generuj tabelę</button>

  <div id="output"></div>

  <div id="buttons" style="display: none;">
    <button id="sendWordBtn" class="btn btn-success">Wyślij Word e-mailem</button>
  </div>
</div>

<script>
  // Generuje tabelkę z dniami roboczymi (pon-pt) w danym miesiącu
  document.getElementById('generateBtn').addEventListener('click', () => {
    const name = document.getElementById('name').value.trim();
    const month = parseInt(document.getElementById('month').value, 10);
    const year = parseInt(document.getElementById('year').value, 10);

    if (!name || isNaN(month) || isNaN(year) || month<1 || month>12) {
      alert("Podaj poprawne dane!");
      return;
    }
    // Liczba dni w miesiącu
    const daysInMonth = new Date(year, month, 0).getDate();

    let html = `<h3>Harmonogram pracy: ${name}</h3>`;
    html += `<p>Miesiąc: ${month}, Rok: ${year}</p>`;
    html += `<table><thead><tr><th>Dzień</th><th>Data</th><th>Roboczy?</th></tr></thead><tbody>`;

    for (let d=1; d<=daysInMonth; d++){
      const date = new Date(year, month-1, d);
      const weekday = date.getDay(); // 0=nd,1=pn,2=wt,...
      const isWorkday = (weekday>=1 && weekday<=5);
      html += `<tr>
        <td>${d}</td>
        <td>${date.toLocaleDateString('pl-PL')}</td>
        <td>${isWorkday ? "TAK" : "WEEKEND"}</td>
      </tr>`;
    }
    html += `</tbody></table>`;

    document.getElementById('output').innerHTML = html;
    document.getElementById('buttons').style.display = 'flex';
  });

  // Funkcja: tworzę Word i wysyłam na /send-docx
  document.getElementById('sendWordBtn').addEventListener('click', async () => {
    const name = document.getElementById('name').value.trim();
    if (!name) return alert("Brak imienia i nazwiska!");

    const outputEl = document.getElementById('output');
    if (!outputEl || !outputEl.innerHTML) {
      return alert("Wygeneruj najpierw tabelę!");
    }

    // Bierzemy docx z window.docx
    const { Document, Packer, Paragraph, Table, TableRow, TableCell, HeadingLevel } = window.docx;
    if (!Document) {
      alert("Biblioteka docx się nie załadowała! Sprawdź link do docx w <head>.");
      return;
    }

    // Tworzymy obiekt Document
    const doc = new Document({
      creator: "Emerlog Simple Generator",
      description: "Wygenerowany grafik pracy"
    });

    const titlePara = new Paragraph({
      text: "Harmonogram pracy - " + name,
      heading: HeadingLevel.HEADING_1
    });

    let children = [ titlePara ];

    // Znajdź tabelę w #output
    const tableEl = outputEl.querySelector('table');
    if (!tableEl) {
      alert("Nie znaleziono tabeli w output!");
      return;
    }

    // Konwertujemy <table> na docx.Table
    const rowEls = Array.from(tableEl.querySelectorAll('tr'));
    const docxRows = rowEls.map((tr) => {
      const cellEls = Array.from(tr.querySelectorAll('th,td'));
      const docxCells = cellEls.map(td => {
        return new TableCell({
          children: [ new Paragraph(td.innerText || "") ]
        });
      });
      return new TableRow({ children: docxCells });
    });

    const docxTable = new Table({ rows: docxRows });
    children.push(docxTable);

    doc.addSection({ children });

    // Eksport do blob
    const blob = await Packer.toBlob(doc);
    // Konwertujemy na base64
    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64 = reader.result.split(",")[1];
      // Wysyłamy do backendu
      try {
        const res = await fetch("/send-docx", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, docxData: base64 })
        });
        if (res.ok) {
          alert("Wysłano Word e-mailem!");
        } else {
          alert("Błąd wysyłki Worda.");
        }
      } catch (err) {
        console.error("Błąd wysyłki Worda", err);
        alert("Błąd wysyłki Worda.");
      }
    };
    reader.readAsDataURL(blob);
  });
</script>

</body>
</html>
