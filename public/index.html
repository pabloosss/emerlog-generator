<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <title>Generator Godzin Emerlog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color:#f9f9f9; font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; color:#333; }
    .container { margin-top:30px; margin-bottom:30px; max-width:1000px; }
    .header { text-align:center; margin-bottom:30px; }
    .header h1 { font-size:32px; font-weight:700; margin-bottom:10px; color:#333; }
    .header p { font-size:16px; color:#555; }
    .card { background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:20px; margin-bottom:30px; }
    .form-group.required .form-label:after { content:"*"; color:red; margin-left:5px; }
    .form-text { font-size:12px; color:#666; }
    .holidays-list li { margin-bottom:5px; }
    .btn { transition:background-color .3s ease; }
    footer { margin-top:40px; text-align:center; color:#777; font-size:.85em; }
    .final-table { width:100%; border-collapse:collapse; margin-top:20px; box-shadow:0 0 5px rgba(0,0,0,0.2); }
    .final-table thead th { font-weight:bold; }
    .final-table th,.final-table td { border:1px solid #000; padding:8px; text-align:center; vertical-align:middle; background-color:#fff; }
    .final-table .holiday td { background-color:#ffcccc; color:#a00; font-weight:bold; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1><i class="fas fa-clock"></i> Generator Godzin Emerlog</h1>
    <p>Wprowadź dane i wybierz rodzaj umowy.</p>
  </div>

  <div class="card mb-4">
    <form id="generatorForm" novalidate>
      <div class="mb-3">
        <label class="form-label">Rodzaj umowy</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contractZlecenie" value="zlecenie" checked />
          <label class="form-check-label" for="contractZlecenie">Umowa zlecenie</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contractPraca" value="praca" />
          <label class="form-check-label" for="contractPraca">Umowa o pracę (pełny etat)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" id="contract34" value="praca3/4" />
          <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3 form-group required">
          <label class="form-label" for="name">Imię i nazwisko</label>
          <input class="form-control" type="text" id="name" required />
          <div class="invalid-feedback">Wpisz imię i nazwisko.</div>
        </div>

        <div class="col-md-6 mb-3 form-group required" id="hoursGroup">
          <label class="form-label" for="hours">Łączna liczba godzin</label>
          <input class="form-control" type="number" id="hours" min="30" step="1" required />
          <div class="invalid-feedback">Wpisz liczbę godzin (minimum 30).</div>

          <div class="form-check mt-2" id="partialMonthWrap">
            <input class="form-check-input" type="checkbox" id="partialMonth" />
            <label class="form-check-label" for="partialMonth">Niepełny miesiąc (bez minimalnego limitu godzin)</label>
          </div>

          <div class="row mt-2" id="partialMonthStartRow" style="display:none;">
            <div class="col">
              <label class="form-label" for="startDate">Data rozpoczęcia pracy (w tym miesiącu)</label>
              <input class="form-control" type="date" id="startDate" />
              <div class="form-text">Godziny będą rozliczane od tej daty włącznie.</div>
            </div>
          </div>

          <small class="form-text" id="hoursHint">
            Zlecenie: 4–16 h/dzień. W „Niepełnym miesiącu” 1–16 h/dzień.
          </small>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3 form-group required">
          <label class="form-label" for="month">Miesiąc</label>
          <select class="form-select" id="month" required>
            <option value="">Wybierz...</option>
            <option value="1">Styczeń</option>
            <option value="2">Luty</option>
            <option value="3">Marzec</option>
            <option value="4">Kwiecień</option>
            <option value="5">Maj</option>
            <option value="6">Czerwiec</option>
            <option value="7">Lipiec</option>
            <option value="8">Sierpień</option>
            <option value="9">Wrzesień</option>
            <option value="10">Październik</option>
            <option value="11">Listopad</option>
            <option value="12">Grudzień</option>
          </select>
          <div class="invalid-feedback">Wybierz miesiąc.</div>
        </div>
        <div class="col-md-4 mb-3 form-group required">
          <label class="form-label" for="year">Rok</label>
          <input class="form-control" type="number" id="year" min="1900" value="2025" required />
          <div class="invalid-feedback">Podaj rok (np. 2025).</div>
        </div>
        <div class="col-md-4 mb-3">
          <small class="form-text">Start ≥ 6:00, koniec ≤ 22:00.</small>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Dodatkowe dni wolne</label>
        <div class="row g-2">
          <div class="col"><input class="form-control" type="date" id="holidayPicker" /></div>
          <div class="col">
            <select class="form-select" id="holidayTypeSelect">
              <option value="Urlop wypoczynkowy">Urlop wypoczynkowy</option>
              <option value="Urlop okolicznościowy">Urlop okolicznościowy</option>
              <option value="Zwolnienie lekarskie (L4)">Zwolnienie lekarskie (L4)</option>
              <option value="Bezpłatny">Urlop bezpłatny</option>
              <option value="Odbiór">Odbiór</option>
              <option value="Inne">Inne</option>
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-secondary" type="button" id="addHoliday">Dodaj wolne</button>
          </div>
        </div>
        <ul class="holidays-list mt-2" id="holidaysList"></ul>
      </div>

      <div class="mb-3 form-check" id="randomHolidaysGroup">
        <input class="form-check-input" type="checkbox" id="randomHolidays" />
        <label class="form-check-label" for="randomHolidays">Dodaj losowo dni wolne</label>
      </div>

      <button class="btn btn-primary" type="submit">Generuj tabelę</button>
    </form>
  </div>

  <div class="table-responsive" id="output"></div>

  <div class="mt-3" id="exportButtons" style="display:none;">
    <button class="btn btn-success" id="generatePDF"><i class="far fa-file-pdf"></i> Pobierz jako PDF</button>
  </div>

  <div class="text-center mt-4">
    <a href="admin.html" class="btn btn-outline-dark">
      <i class="fas fa-user-shield"></i> Panel Administratora
    </a>
  </div>
</div>

<footer>© 2025 Emerlog</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(function(){
  "use strict";

  var fixedHolidays = [
    "01-01","06-01","20-04","21-04","01-05","03-05","08-06","19-06",
    "15-08","01-11","11-11","25-12","26-12"
  ];
  var monthNames = ["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
  window.customHolidays = window.customHolidays || [];

  // Limity zlecenia
  var MIN_ZL_FULL = 4,  MAX_ZL_FULL = 16; // pełny miesiąc
  var MIN_ZL_PART = 1,  MAX_ZL_PART = 16; // niepełny miesiąc

  function checkCustomHoliday(day, month, year){
    var dd = String(day).padStart(2,'0');
    var mm = String(month).padStart(2,'0');
    var yyyy = String(year).padStart(4,'0');
    var fullDate = yyyy + "-" + mm + "-" + dd;
    return window.customHolidays.find(function(x){ return x.date === fullDate; }) || null;
  }
  function isFixedHoliday(day, month){
    var dd = String(day).padStart(2,'0');
    var mm = String(month).padStart(2,'0');
    return fixedHolidays.includes(dd+"-"+mm);
  }
  function isWeekend(d){ var w=d.getDay(); return (w===0||w===6); }

  document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll('input[name="contractType"]').forEach(function(rad){
      rad.addEventListener("change", onContractChange);
    });

    var form = document.getElementById("generatorForm");
    form.addEventListener("submit", function(e){
      e.preventDefault();
      if(!form.checkValidity()){
        e.stopPropagation();
      } else {
        generateTable();
      }
      form.classList.add("was-validated");
    });

    document.getElementById("addHoliday").addEventListener("click", function(){
      var selDate = document.getElementById("holidayPicker").value;
      var holidayType = document.getElementById("holidayTypeSelect").value;
      if(!selDate){ alert("Wybierz datę!"); return; }
      if(!window.customHolidays.find(function(x){ return x.date === selDate; })){
        window.customHolidays.push({ date: selDate, type: holidayType });
      } else {
        alert("Ten dzień jest już dodany jako wolny!");
      }
      renderHolidays();
    });

    document.getElementById("month").addEventListener("change", function(){
      updateHolidayPickerRange(); updateStartDateRange();
    });
    document.getElementById("year").addEventListener("change", function(){
      updateHolidayPickerRange(); updateStartDateRange();
    });
    document.getElementById("partialMonth").addEventListener("change", onPartialChange);

    onContractChange();
    updateStartDateRange();
  });

  function onContractChange(){
    var type = document.querySelector('input[name="contractType"]:checked').value;
    var randomH = document.getElementById("randomHolidays");
    var hoursGroup = document.getElementById("hoursGroup");
    var hoursInput = document.getElementById("hours");
    var holidayTypeSelect = document.getElementById("holidayTypeSelect");
    var partialWrap = document.getElementById("partialMonthWrap");

    if(type==="zlecenie"){
      hoursGroup.style.display="block"; hoursInput.required=true; hoursInput.min="30";
      partialWrap.style.display="block"; onPartialChange();
      randomH.checked=false; randomH.disabled=false;
      holidayTypeSelect.innerHTML="";
      ["---","Zwolnienie lekarskie (L4)"].forEach(function(o){
        var opt=document.createElement("option"); opt.value=o; opt.textContent=o; holidayTypeSelect.appendChild(opt);
      });
    } else {
      hoursGroup.style.display="none"; hoursInput.required=false; hoursInput.removeAttribute("min");
      document.getElementById("partialMonth").checked=false;
      document.getElementById("partialMonthStartRow").style.display="none";
      partialWrap.style.display="none";
      randomH.checked=false; randomH.disabled=false;
      holidayTypeSelect.innerHTML="";
      ["Urlop wypoczynkowy","Urlop okolicznościowy","Zwolnienie lekarskie (L4)","Bezpłatny","Odbiór","Inne"].forEach(function(o){
        var opt=document.createElement("option"); opt.value=o; opt.textContent=o; holidayTypeSelect.appendChild(opt);
      });
    }
  }
  function onPartialChange(){
    var isPartial = document.getElementById("partialMonth").checked;
    var hoursInput = document.getElementById("hours");
    var startRow = document.getElementById("partialMonthStartRow");
    if(isPartial){ hoursInput.removeAttribute("min"); startRow.style.display="block"; updateStartDateRange(); }
    else { hoursInput.min="30"; startRow.style.display="none"; document.getElementById("startDate").value=""; }
  }

  function renderHolidays(){
    var ul = document.getElementById("holidaysList"); ul.innerHTML="";
    window.customHolidays.forEach(function(item){
      var li=document.createElement("li"); li.textContent=item.date+" – "+item.type;
      var btn=document.createElement("button"); btn.textContent="Usuń"; btn.classList.add("btn","btn-sm","btn-danger","ms-2");
      btn.addEventListener("click", function(){ window.customHolidays=window.customHolidays.filter(function(x){return x!==item;}); renderHolidays(); });
      li.appendChild(btn); ul.appendChild(li);
    });
  }

  function updateHolidayPickerRange(){
    var mVal=parseInt(document.getElementById("month").value,10);
    var yVal=parseInt(document.getElementById("year").value,10);
    var holidayPicker=document.getElementById("holidayPicker");
    if(!mVal||!yVal){ holidayPicker.removeAttribute("min"); holidayPicker.removeAttribute("max"); return; }
    var daysInMonth=new Date(yVal,mVal,0).getDate();
    var mm=String(mVal).padStart(2,'0');
    var minDate=yVal+"-"+mm+"-01"; var maxDate=yVal+"-"+mm+"-"+daysInMonth;
    holidayPicker.setAttribute("min",minDate); holidayPicker.setAttribute("max",maxDate);
    if(holidayPicker.value&&(holidayPicker.value<minDate||holidayPicker.value>maxDate)){ holidayPicker.value=""; }
  }
  function updateStartDateRange(){
    var mVal=parseInt(document.getElementById("month").value,10);
    var yVal=parseInt(document.getElementById("year").value,10);
    var startInput=document.getElementById("startDate"); if(!startInput) return;
    if(!mVal||!yVal){ startInput.removeAttribute("min"); startInput.removeAttribute("max"); return; }
    var daysInMonth=new Date(yVal,mVal,0).getDate();
    var mm=String(mVal).padStart(2,'0'); var minDate=yVal+"-"+mm+"-01"; var maxDate=yVal+"-"+mm+"-"+daysInMonth;
    startInput.setAttribute("min",minDate); startInput.setAttribute("max",maxDate);
    if(startInput.value&&(startInput.value<minDate||startInput.value>maxDate)){ startInput.value=""; }
  }

  // Rozkład godzin z ograniczeniami
  function distributeHours(totalHours, daysCount, MIN_DAY, MAX_DAY) {
    if(daysCount===0){ return (totalHours===0)?[]:null; }
    var minPossible=MIN_DAY*daysCount, maxPossible=MAX_DAY*daysCount;
    if(totalHours<minPossible){ alert(`Za mało godzin (min. ${minPossible}).`); return null; }
    if(totalHours>maxPossible){ alert(`Za dużo godzin (max. ${maxPossible}).`); return null; }

    var base=new Array(daysCount).fill(MIN_DAY);
    var remaining=totalHours-minPossible;

    var weights=Array.from({length:daysCount},function(){return Math.random();});
    var wsum=weights.reduce(function(a,b){return a+b;},0)||1;
    var extra=weights.map(function(w){return Math.floor(w/wsum*remaining);});
    var allocSum=extra.reduce(function(a,b){return a+b;},0);
    var leftover=remaining-allocSum;

    while(leftover>0){
      var candidates=[];
      for(var i=0;i<daysCount;i++){ if(base[i]+extra[i]<MAX_DAY) candidates.push(i); }
      if(candidates.length===0) break;
      var pick=candidates[Math.floor(Math.random()*candidates.length)];
      extra[pick]++; leftover--;
    }
    var arr=base.map(function(b,i){return b+extra[i];});

    for(let s=arr.length-1;s>0;s--){ const j=Math.floor(Math.random()*(s+1)); [arr[s],arr[j]]=[arr[j],arr[s]]; }
    return arr;
  }

  // Użyj maksymalnej liczby dni roboczych, ale nie mniej niż minK
  function chooseWorkDays(totalHours, totalWorkingDays, minPerDay, maxPerDay){
    const minK = Math.ceil(totalHours / maxPerDay);
    const maxK = Math.floor(totalHours / minPerDay);
    if (minK > totalWorkingDays) return null;
    const k = Math.min(totalWorkingDays, Math.max(minK, Math.min(maxK, totalWorkingDays)));
    return k;
  }
  function selectEvenIndices(len, k){
    const set = new Set();
    const step = len / k;
    for(let j=0;j<k;j++){ set.add(Math.min(len-1, Math.round(j*step))); }
    while(set.size < k){ set.add(Math.floor(Math.random()*len)); }
    return Array.from(set).sort((a,b)=>a-b);
  }

  function getRandomInt(mi,ma){ mi=Math.ceil(mi); ma=Math.floor(ma); return (ma<mi)?mi:Math.floor(Math.random()*(ma-mi+1))+mi; }
  function pickStartHour(duration, prevStart){
    var minStart=6, maxStart=22-duration; if(maxStart<minStart) maxStart=minStart;
    var chosen=getRandomInt(minStart,maxStart), attempts=0;
    while(attempts<10 && chosen===prevStart && (maxStart>minStart)){ chosen=getRandomInt(minStart,maxStart); attempts++; }
    return chosen;
  }
  function assignTimes(workingDays, hoursArr){
    var prevStart=null;
    for(var i=0;i<workingDays.length;i++){
      var wd=workingDays[i]; var dur=hoursArr[i];
      var sH=pickStartHour(dur,prevStart);
      if(sH+dur>22){ sH=Math.max(6,22-dur); }
      var eH=sH+dur; if(eH>22){ eH=22; sH=eH-dur; if(sH<6) sH=6; }
      wd.hours=dur; wd.start=sH+":00"; wd.end=eH+":00"; prevStart=sH;
    }
    return true;
  }

  async function generateTable(){
    var fullName=document.getElementById("name").value.trim();
    var monthVal=parseInt(document.getElementById("month").value,10);
    var yearVal=parseInt(document.getElementById("year").value,10);
    var addRandom=document.getElementById("randomHolidays").checked;
    var contractType=document.querySelector('input[name="contractType"]:checked').value;
    var isPartial=document.getElementById("partialMonth").checked;
    var startDateVal=document.getElementById("startDate").value;

    if(!fullName||!monthVal||!yearVal){ alert("Proszę wypełnić wszystkie wymagane pola!"); return; }
    if(contractType==="zlecenie" && isPartial && !startDateVal){ alert("Wybierz datę rozpoczęcia pracy (Niepełny miesiąc)."); return; }

    var daysInMonth=new Date(yearVal,monthVal,0).getDate();
    var dayData=[];
    for(var d=1; d<=daysInMonth; d++){
      var dateObj=new Date(yearVal,monthVal-1,d);
      var cHol=checkCustomHoliday(d,monthVal,yearVal);
      var weekend=isWeekend(dateObj);
      var fixHol=isFixedHoliday(d,monthVal);
      var holType=""; if(cHol){ holType=cHol.type; } else if(fixHol){ holType="Święto"; }
      var isWork=(!weekend && !fixHol && !cHol);
      dayData.push({ day:d, date:dateObj, isWorkingDay:isWork, holidayType:holType, hours:0, start:"-", end:"-" });
    }

    if(contractType==="zlecenie" && isPartial && startDateVal){
      var startObj=new Date(startDateVal+"T00:00:00");
      dayData.forEach(function(dd){ if(dd.date<startObj && dd.isWorkingDay){ dd.isWorkingDay=false; dd.holidayType="Nie było"; } });
    }

    if(contractType==="zlecenie" && addRandom && !isPartial){
      var pattern=[0,1,2,1,0,0], grouped={};
      dayData.forEach(function(it){ var week=Math.floor((it.day-1)/7)+1; if(!grouped[week]) grouped[week]=[]; grouped[week].push(it); });
      Object.keys(grouped).forEach(function(k){
        var arr=grouped[k].filter(function(x){return x.isWorkingDay;});
        var need=pattern[parseInt(k)-1]||0; need=Math.min(need,arr.length);
        if(need>0){ arr.sort(function(){return 0.5-Math.random();}); arr.slice(0,need).forEach(function(dd){ dd.isWorkingDay=false; dd.holidayType="Losowy dzień wolny"; }); }
      });
    }

    var workingDays = dayData.filter(function(x){ return x.isWorkingDay; });
    var totalHours = 0;

    if(contractType==="praca"){
      workingDays.forEach(function(d){ d.hours=8; d.start="8:00"; d.end="16:00"; });
      totalHours=workingDays.length*8;

    } else if(contractType==="praca3/4"){
      workingDays.forEach(function(d){ d.hours=6; d.start="8:00"; d.end="14:00"; });
      totalHours=workingDays.length*6;

    } else if(contractType==="zlecenie"){
      totalHours=parseInt(document.getElementById("hours").value,10);
      if(isNaN(totalHours)||totalHours<0){ alert("Podaj nieujemną liczbę godzin."); return; }
      if(!isPartial && totalHours<30){ alert("Minimalna łączna liczba godzin dla umowy zlecenie to 30."); return; }

      if(isPartial){
        if(workingDays.length===0){ alert("Brak pracujących dni od wskazanej daty w tym miesiącu."); return; }
        var W=workingDays.length; var minRequired=Math.max(1,W-2);
        if(totalHours<minRequired){ alert(`Za mało godzin. Min ${minRequired} h.`); return; }
        var fillCount=Math.min(W,totalHours);
        if(fillCount<W){
          var toSkip=W-fillCount;
          for(var s=W-toSkip; s<W; s++){ workingDays[s].isWorkingDay=false; workingDays[s].holidayType="Niepełny miesiąc"; }
          workingDays=workingDays.slice(0,fillCount);
        }
        var hoursArrP=distributeHours(totalHours,workingDays.length,MIN_ZL_PART,MAX_ZL_PART); if(!hoursArrP) return;
        if(!assignTimes(workingDays,hoursArrP)) return;

      } else {
        // Maksymalizuj liczbę dni przy 4–16 h/dzień
        const WDIdx = dayData.map((d,i)=> d.isWorkingDay ? i : -1).filter(i=> i>=0);
        const k = chooseWorkDays(totalHours, WDIdx.length, MIN_ZL_FULL, MAX_ZL_FULL);
        if (k === null){ alert(`Za dużo godzin (${totalHours}) na dostępne dni (${WDIdx.length}).`); return; }

        const picksRel = selectEvenIndices(WDIdx.length, k);
        const picksAbs = new Set(picksRel.map(i=> WDIdx[i]));
        for (const i of WDIdx){
          if(!picksAbs.has(i)){ dayData[i].isWorkingDay = false; dayData[i].holidayType = "—"; }
        }
        workingDays = dayData.filter(x=> x.isWorkingDay);

        var hoursArr = distributeHours(totalHours, workingDays.length, MIN_ZL_FULL, MAX_ZL_FULL);
        if(!hoursArr) return;
        if(!assignTimes(workingDays, hoursArr)) return;
      }
    }

    var nameParts=fullName.split(/\s+/); var lastName=nameParts.slice(1).join(" ");

    var rows=dayData.map(function(inf){
      var dd=String(inf.day).padStart(2,'0');
      var mm=String(document.getElementById("month").value).padStart(2,'0');
      var yyyy=document.getElementById("year").value;
      var wkd=inf.date.toLocaleString('pl-PL',{weekday:'short'});
      if(inf.isWorkingDay){
        return `<tr>
          <td>${inf.day}</td><td>${dd}.${mm}.${yyyy} (${wkd})</td>
          <td>${inf.start}</td><td>${inf.end}</td><td>${inf.hours}</td>
          <td>${lastName}</td><td></td><td>-</td>
        </tr>`;
      } else {
        var shownHoliday=(inf.holidayType==="Losowy dzień wolny")?"-":(inf.holidayType||"-");
        return `<tr class="holiday">
          <td>${inf.day}</td><td>${dd}.${mm}.${yyyy} (${wkd})</td>
          <td>-</td><td>-</td><td>0</td>
          <td>${lastName}</td><td></td><td>${shownHoliday}</td>
        </tr>`;
      }
    });

    var sumOfHours=dayData.filter(function(d){return d.isWorkingDay;}).reduce(function(a,b){return a+b.hours;},0);
    rows.push(`<tr class="fw-bold"><td colspan="4">Suma godzin:</td><td>${sumOfHours}</td><td colspan="3"></td></tr>`);

    var tableHTML=`
      <h3 class="mt-4">${monthNames[monthVal-1]} ${yearVal}</h3>
      <h4>${fullName}</h4>
      <p><strong>${
        contractType==="praca" ? "Umowa o pracę (8:00 - 16:00)" :
        contractType==="praca3/4" ? "Umowa o pracę (3/4 etatu, 8:00 - 14:00)" : "Umowa zlecenie"
      }</strong>${(contractType==="zlecenie"&&isPartial)?" – tryb: Niepełny miesiąc":""}</p>
      <table class="final-table">
        <thead>
          <tr>
            <th>Dzień</th><th>Data</th><th>Godz. rozpoczęcia</th><th>Godz. zakończenia</th>
            <th>Suma godzin</th><th>Podpis zleceniobiorcy</th><th>Podpis zleceniodawcy</th><th>Urlop</th>
          </tr>
        </thead>
        <tbody>${rows.join("")}</tbody>
      </table>
    `;
    document.getElementById("output").innerHTML=tableHTML;
    document.getElementById("exportButtons").style.display="block";
    document.getElementById("generatePDF").onclick=downloadPDF;
  }

  async function downloadPDF(){
    try{
      var jsPDF=window.jspdf.jsPDF;
      var pdf=new jsPDF("portrait","pt","a4");
      var pageWidth=pdf.internal.pageSize.getWidth();
      var pageHeight=pdf.internal.pageSize.getHeight();
      var outputEl=document.getElementById("output");
      if(!outputEl){ alert("Najpierw wygeneruj tabelę."); return; }
      var canvas=await html2canvas(outputEl,{ scale:1, useCORS:true, allowTaint:false });
      pdf.addImage(canvas.toDataURL("image/png"),"PNG",0,0,pageWidth,pageHeight);
      pdf.save("Tabela_Godzinowa_Pion.pdf");
    }catch(err){
      console.error("Błąd PDF:",err);
      alert("Nie udało się wygenerować PDF.");
    }
  }

})();
</script>
</body>
</html>
