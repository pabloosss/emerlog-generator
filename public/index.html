<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generator Godzin Emerlog</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    body{background:#f9f9f9;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .container{max-width:1000px}
    .card{border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .final-table{width:100%;border-collapse:collapse;margin-top:16px;box-shadow:0 0 5px rgba(0,0,0,.2)}
    .final-table th,.final-table td{border:1px solid #000;padding:8px;text-align:center;background:#fff}
    .final-table thead th{background:#f4f4f4;font-weight:700}
    .final-table .holiday td{background:#ffcccc;color:#a00;font-weight:700}
    #sendingSpinner{display:none;text-align:center}
  </style>
</head>
<body>
<div class="container my-4">
  <div class="text-center mb-3">
    <h1 class="h4"><i class="fa-solid fa-clock"></i> Generator Godzin Emerlog</h1>
  </div>

  <div class="card p-3 mb-4">
    <form id="generatorForm" novalidate>
      <div class="mb-3">
        <label class="form-label">Rodzaj umowy</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" value="zlecenie" id="contractZ" checked>
          <label class="form-check-label" for="contractZ">Umowa zlecenie</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" value="praca" id="contractP">
          <label class="form-check-label" for="contractP">Umowa o pracę (pełny etat)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="contractType" value="praca3/4" id="contract34">
          <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="name" class="form-label">Imię i nazwisko</label>
          <input id="name" class="form-control" required>
          <div class="invalid-feedback">Wpisz imię i nazwisko.</div>
        </div>

        <div class="col-md-6 mb-3" id="hoursGroup">
          <label for="hours" class="form-label">Łączna liczba godzin</label>
          <input id="hours" type="number" class="form-control" min="30" step="1" required>
          <div class="invalid-feedback">Min. 30 godzin.</div>

          <div class="form-check mt-2" id="partialMonthWrap">
            <input class="form-check-input" type="checkbox" id="partialMonth">
            <label class="form-check-label" for="partialMonth">Niepełny miesiąc</label>
          </div>

          <div class="row mt-2" id="partialMonthStartRow" style="display:none;">
            <div class="col">
              <label class="form-label" for="startDate">Data rozpoczęcia (w tym miesiącu)</label>
              <input class="form-control" type="date" id="startDate">
              <div class="form-text">Od tej daty min. 1h/dzień. Można pominąć 2 ostatnie dni.</div>
            </div>
          </div>

          <small class="text-muted d-block mt-1">Zlecenie: 4–12 h/dzień. W niepełnym miesiącu brak minimum łącznego.</small>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label" for="month">Miesiąc</label>
          <select id="month" class="form-select" required>
            <option value="">Wybierz…</option>
            <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
            <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
            <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
            <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
          </select>
          <div class="invalid-feedback">Wybierz miesiąc.</div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label" for="year">Rok</label>
          <input id="year" type="number" class="form-control" min="2000" required value="2025">
          <div class="invalid-feedback">Podaj rok.</div>
        </div>
        <div class="col-md-4 mb-3 align-self-end">
          <small class="text-muted">Godziny: start ≥ 7:00, koniec ≤ 20:00.</small>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Dodatkowe dni wolne</label>
        <div class="row g-2">
          <div class="col"><input class="form-control" type="date" id="holidayPicker"></div>
          <div class="col">
            <select class="form-select" id="holidayTypeSelect"></select>
          </div>
          <div class="col-auto">
            <button class="btn btn-secondary" type="button" id="addHoliday">Dodaj wolne</button>
          </div>
        </div>
        <ul class="mt-2" id="holidaysList"></ul>
      </div>

      <div class="form-check mb-2" id="randomHolidaysGroup">
        <input class="form-check-input" type="checkbox" id="randomHolidays">
        <label class="form-check-label" for="randomHolidays">Dodaj losowo dni wolne</label>
      </div>

      <button class="btn btn-primary" type="submit">Generuj tabelę</button>
    </form>
  </div>

  <div id="output" class="table-responsive"></div>

  <div id="exportButtons" class="mt-3" style="display:none;">
    <button class="btn btn-success" id="generatePDF"><i class="fa-regular fa-file-pdf"></i> Pobierz PDF</button>
    <button class="btn btn-primary ms-2" id="sendPDFEmail">Wyślij e-mailem</button>
    <div id="sendingSpinner" class="mt-2">
      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
      <p class="mb-0">Trwa wysyłanie…</p>
    </div>
  </div>

  <div class="text-center mt-4">
    <a class="btn btn-outline-dark" href="admin.html"><i class="fa-solid fa-user-shield"></i> Panel Administratora</a>
  </div>
</div>

<script>
(function(){
  "use strict";
  const API_KEY = "e01a9e1ea26f12e119d268a2a5abeb82dc162ae7ba6cd349b7ca463a5808f1a1";
  const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
  window.customHolidays=[];

  // Święta PL
  function easterSunday(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day)}
  const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}
  const toISO=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  function getPolishPublicHolidays(year){
    const fixed=["01-01","01-06","05-01","05-03","08-15","11-01","11-11","12-25","12-26"].map(md=>`${year}-${md}`);
    const e=easterSunday(year); return new Set([...fixed,toISO(addDays(e,1)),toISO(addDays(e,60))]);
  }
  const isPublicHoliday=(date,set)=>set.has(toISO(date));

  // UI helpers
  function setHolidayTypeOptions(contractType){
    const sel=document.getElementById("holidayTypeSelect");
    sel.innerHTML="";
    const opts=contractType==="zlecenie"?["---","Zwolnienie lekarskie (L4)"]:
      ["Urlop wypoczynkowy","Urlop okolicznościowy","Zwolnienie lekarskie (L4)","Bezpłatny","Odbiór","Inne"];
    opts.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;sel.appendChild(o);});
  }
  function updateHolidayPickerRange(){
    const m=+document.getElementById("month").value, y=+document.getElementById("year").value, p=document.getElementById("holidayPicker");
    if(!m||!y){p.removeAttribute("min");p.removeAttribute("max");return;}
    const days=new Date(y,m,0).getDate(), mm=String(m).padStart(2,'0');
    p.min=`${y}-${mm}-01`; p.max=`${y}-${mm}-${days}`;
    if(p.value && (p.value<p.min || p.value>p.max)) p.value="";
  }
  function updateStartDateRange(){
    const m=+document.getElementById("month").value, y=+document.getElementById("year").value, s=document.getElementById("startDate");
    if(!s)return;
    if(!m||!y){s.removeAttribute("min");s.removeAttribute("max");return;}
    const days=new Date(y,m,0).getDate(), mm=String(m).padStart(2,'0');
    s.min=`${y}-${mm}-01`; s.max=`${y}-${mm}-${days}`;
    if(s.value && (s.value<s.min || s.value>s.max)) s.value="";
  }
  function addHoliday(){
    const date=document.getElementById("holidayPicker").value;
    const type=document.getElementById("holidayTypeSelect").value;
    if(!date){alert("Wybierz datę.");return;}
    if(window.customHolidays.find(x=>x.date===date)){alert("Ten dzień już dodany.");return;}
    window.customHolidays.push({date,type}); renderHolidays();
  }
  function renderHolidays(){
    const ul=document.getElementById("holidaysList"); ul.innerHTML="";
    window.customHolidays.forEach(item=>{
      const li=document.createElement("li"); li.textContent=item.date+" – "+item.type;
      const btn=document.createElement("button"); btn.className="btn btn-sm btn-danger ms-2"; btn.textContent="Usuń";
      btn.onclick=()=>{window.customHolidays=window.customHolidays.filter(x=>x!==item); renderHolidays();};
      li.appendChild(btn); ul.appendChild(li);
    });
  }

  // generatory godzin
  function distributeHours(total, n, minD, maxD){
    if(n===0) return total===0?[]:null;
    const minP=minD*n, maxP=maxD*n;
    if(total<minP){alert(`Za mało godzin (min. ${minP}).`);return null;}
    if(total>maxP){alert(`Za dużo godzin (max. ${maxP}).`);return null;}
    const arr=Array(n).fill(minD); let rem=total-minP;
    const sh=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}};
    while(rem>0){
      const idx=[...Array(n).keys()]; sh(idx);
      let moved=false;
      for(const i of idx){
        if(rem===0) break;
        const cap=maxD-arr[i]; if(cap<=0) continue;
        const add=Math.min(cap, Math.max(1, Math.floor(Math.random()*Math.min(3,rem)+1)));
        arr[i]+=add; rem-=add; moved=true;
      }
      if(!moved){alert("Nie da się rozdzielić godzin.");return null;}
    }
    sh(arr); return arr;
  }
  const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  function pickStartHour(dur, prev){let minS=7,maxS=Math.max(7,20-dur);let s=rint(minS,maxS),t=0;while(t<8&&s===prev&&maxS>minS){s=rint(minS,maxS);t++;}return s;}
  function assignTimes(days, hours){
    let prev=null;
    for(let i=0;i<days.length;i++){
      const dur=hours[i]; let s=pickStartHour(dur,prev); if(s+dur>20) s=Math.max(7,20-dur);
      let e=s+dur; if(e>20){e=20;s=e-dur;if(s<7)s=7;}
      days[i].hours=dur; days[i].start=s+":00"; days[i].end=e+":00"; prev=s;
    }
  }
  function chooseWorkDays(totalHours,totalWD,minD,maxD){
    const minK=Math.ceil(totalHours/maxD), maxK=Math.floor(totalHours/minD);
    if(minK>totalWD) return null;
    const ideal=Math.round(totalHours/((minD+maxD)/2));
    return Math.min(totalWD, Math.max(minK, Math.min(maxK, ideal)));
  }
  function selectEvenIndices(len,k){
    const set=new Set(), step=len/k;
    for(let j=0;j<k;j++) set.add(Math.min(len-1, Math.round(j*step)));
    while(set.size<k) set.add(Math.floor(Math.random()*len));
    return [...set].sort((a,b)=>a-b);
  }

  // generowanie tabeli
  function generateTable(){
    const name=document.getElementById("name").value.trim();
    const monthVal=+document.getElementById("month").value;
    const yearVal=+document.getElementById("year").value;
    const contractType=document.querySelector('input[name="contractType"]:checked').value;
    const isPartial=document.getElementById("partialMonth").checked;
    const startDateVal=document.getElementById("startDate").value;
    const addRandom=document.getElementById("randomHolidays").checked;

    if(!name){alert("Podaj imię i nazwisko.");return;}
    if(!monthVal||!yearVal){alert("Wybierz miesiąc i rok.");return;}
    if(contractType==="zlecenie"&&isPartial&&!startDateVal){alert("Podaj datę rozpoczęcia.");return;}

    const holidaysSet=getPolishPublicHolidays(yearVal);
    const daysInMonth=new Date(yearVal,monthVal,0).getDate();
    const dayData=[];
    for(let d=1; d<=daysInMonth; d++){
      const date=new Date(yearVal,monthVal-1,d);
      const weekend=(date.getDay()===0||date.getDay()===6);
      const fixHol=isPublicHoliday(date,holidaysSet);
      const iso=`${yearVal}-${String(monthVal).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const custom=window.customHolidays.find(x=>x.date===iso);
      const holType=custom?custom.type:(fixHol?"Święto":"");
      dayData.push({day:d,date,isWorkingDay:(!weekend&&!fixHol&&!custom),holidayType:holType,hours:0,start:"-",end:"-"});
    }

    if(contractType==="zlecenie"&&isPartial){
      const s=new Date(startDateVal+"T00:00:00");
      dayData.forEach(dd=>{ if(dd.date<s&&dd.isWorkingDay){dd.isWorkingDay=false;dd.holidayType="Nie było";} });
    }

    if(contractType==="zlecenie"&&addRandom&&!isPartial){
      const pattern=[0,1,3,1,0,0], grouped={};
      dayData.forEach(it=>{const w=Math.floor((it.day-1)/7)+1; (grouped[w]||(grouped[w]=[])).push(it);});
      Object.keys(grouped).forEach(k=>{
        const arr=grouped[k].filter(x=>x.isWorkingDay); let need=pattern[+k-1]||0; need=Math.min(need,arr.length);
        if(need>0){ arr.sort(()=>0.5-Math.random()); arr.slice(0,need).forEach(dd=>{dd.isWorkingDay=false;dd.holidayType="—";}); }
      });
    }

    let workingDays=dayData.filter(x=>x.isWorkingDay);
    let totalHours=0;

    if(contractType==="praca"){
      workingDays.forEach(d=>{d.hours=8;d.start="8:00";d.end="16:00";}); totalHours=workingDays.length*8;
    }else if(contractType==="praca3/4"){
      workingDays.forEach(d=>{d.hours=6;d.start="8:00";d.end="14:00";}); totalHours=workingDays.length*6;
    }else{
      totalHours=parseInt(document.getElementById("hours").value,10);
      if(Number.isNaN(totalHours)||totalHours<0){alert("Podaj poprawną liczbę godzin.");return;}
      if(!isPartial&&totalHours<30){alert("Minimalnie 30 h.");return;}

      if(isPartial){
        if(workingDays.length===0){alert("Brak dni roboczych od daty startu.");return;}
        const W=workingDays.length, minReq=Math.max(1,W-2);
        if(totalHours<minReq){alert(`Za mało godzin. Minimum ${minReq}.`);return;}
        const fill=Math.min(W,totalHours);
        if(fill<W){ for(let i=W-(W-fill); i<W; i++){workingDays[i].isWorkingDay=false;workingDays[i].holidayType="Niepełny miesiąc";} workingDays=workingDays.slice(0,fill); }
        const arr=distributeHours(totalHours,workingDays.length,1,12); if(!arr)return; assignTimes(workingDays,arr);
      }else{
        const idx=dayData.map((d,i)=>d.isWorkingDay?i:-1).filter(i=>i>=0);
        const k=chooseWorkDays(totalHours,idx.length,4,12); if(k===null){alert(`Za dużo godzin względem dni roboczych (${idx.length}).`);return;}
        const picksRel=selectEvenIndices(idx.length,k); const picksAbs=new Set(picksRel.map(i=>idx[i]));
        for(const i of idx){ if(!picksAbs.has(i)){ dayData[i].isWorkingDay=false; dayData[i].holidayType="—"; } }
        workingDays=dayData.filter(x=>x.isWorkingDay);
        const arr=distributeHours(totalHours,workingDays.length,4,12); if(!arr)return; assignTimes(workingDays,arr);
      }
    }

    // render jak na zrzucie
    const rows=dayData.map(inf=>{
      const dd=String(inf.day).padStart(2,'0'), mm=String(monthVal).padStart(2,'0'), yyyy=yearVal;
      const wkd=inf.date.toLocaleString('pl-PL',{weekday:'short'});
      if(inf.isWorkingDay){
        return `<tr>
          <td>${inf.day}</td>
          <td><b>${dd}.${mm}.${yyyy} (${wkd})</b></td>
          <td>${inf.start}</td><td>${inf.end}</td>
          <td>${inf.hours}</td>
          <td>${name}</td><td></td><td>-</td>
        </tr>`;
      } else {
        return `<tr class="holiday">
          <td>${inf.day}</td>
          <td><b>${dd}.${mm}.${yyyy} (${wkd})</b></td>
          <td>-</td><td>-</td>
          <td>0</td>
          <td>${name}</td><td></td><td>${inf.holidayType||"-"}</td>
        </tr>`;
      }
    });
    const sum=dayData.filter(d=>d.isWorkingDay).reduce((a,b)=>a+b.hours,0);

    document.getElementById("output").innerHTML=`
      <h3 class="mt-2">${monthNames[monthVal-1]} ${yearVal}</h3>
      <h4 class="h6">${name}</h4>
      <table class="final-table">
        <thead>
          <tr>
            <th>Dzień</th><th>Data</th><th>Godz. rozpoczęcia</th><th>Godz. zakończenia</th>
            <th>Suma godzin</th><th>Podpis zleceniobiorcy</th><th>Podpis zleceniodawcy</th><th>Urlop</th>
          </tr>
        </thead>
        <tbody>
          ${rows.join("")}
          <tr class="fw-bold"><td colspan="4">Suma godzin:</td><td>${sum}</td><td colspan="3"></td></tr>
        </tbody>
      </table>`;
    document.getElementById("exportButtons").style.display="block";

    // cache do PDF/mail
    window.__lastReport={name,monthVal,yearVal,sumOfHours:sum,dayData:dayData.map(d=>({...d}))};
  }

  // PDF prosty (zrzut HTML do obrazu można dodać później)
  async function downloadPDF(){
    const ctx=window.__lastReport; if(!ctx){alert("Najpierw wygeneruj tabelę.");return;}
    const jsPDF=window.jspdf.jsPDF; const pdf=new jsPDF("portrait","pt","a4");
    pdf.text(`Ewidencja — ${ctx.monthVal}/${ctx.yearVal} — ${ctx.name}`,40,40);
    pdf.text(`Suma godzin: ${ctx.sumOfHours}`,40,60);
    pdf.save(`Ewidencja_${ctx.yearVal}-${String(ctx.monthVal).padStart(2,'0')}.pdf`);
  }

  async function sendPDFEmail(){
    const ctx=window.__lastReport; if(!ctx){alert("Najpierw wygeneruj tabelę.");return;}
    document.getElementById("sendingSpinner").style.display="block";
    try{
      const jsPDF=window.jspdf.jsPDF; const pdf=new jsPDF("portrait","pt","a4");
      pdf.text(`Ewidencja — ${ctx.monthVal}/${ctx.yearVal} — ${ctx.name}`,40,40);
      pdf.text(`Suma godzin: ${ctx.sumOfHours}`,40,60);
      const blob=pdf.output("blob");
      const base64=await new Promise(res=>{const r=new FileReader(); r.onloadend=()=>res(r.result.split(",")[1]); r.readAsDataURL(blob);});
      const r=await fetch("/send-pdf",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":API_KEY},body:JSON.stringify({name:ctx.name,pdfData:base64})});
      document.getElementById("sendingSpinner").style.display="none";
      if(r.ok){alert("PDF wysłany e-mailem.");} else {alert("Błąd wysyłki: "+(await r.text()));}
    }catch(e){console.error(e);document.getElementById("sendingSpinner").style.display="none";alert("Błąd przeglądarki.");}
  }

  // init
  document.addEventListener("DOMContentLoaded",()=>{
    const t=new Date(); if(!document.getElementById("month").value) document.getElementById("month").value=String(t.getMonth()+1);
    setHolidayTypeOptions("zlecenie"); updateHolidayPickerRange(); updateStartDateRange();

    document.querySelectorAll('input[name="contractType"]').forEach(r=>r.addEventListener("change", e=>{
      setHolidayTypeOptions(e.target.value);
      const type=e.target.value, hoursGroup=document.getElementById("hoursGroup"), randomGrp=document.getElementById("randomHolidaysGroup");
      if(type==="zlecenie"){hoursGroup.style.display="block";randomGrp.style.display="block";}
      else{hoursGroup.style.display="none";randomGrp.style.display="none";document.getElementById("randomHolidays").checked=false;document.getElementById("partialMonth").checked=false;document.getElementById("partialMonthStartRow").style.display="none";}
    }));
    document.getElementById("partialMonth").addEventListener("change", ()=>{
      const ch=document.getElementById("partialMonth").checked;
      const row=document.getElementById("partialMonthStartRow");
      const hours=document.getElementById("hours");
      if(ch){row.style.display="block";hours.removeAttribute("min");updateStartDateRange();}
      else{row.style.display="none";hours.min="30";document.getElementById("startDate").value="";}
    });
    document.getElementById("addHoliday").addEventListener("click", addHoliday);
    document.getElementById("month").addEventListener("change", ()=>{updateHolidayPickerRange();updateStartDateRange();});
    document.getElementById("year").addEventListener("change",  ()=>{updateHolidayPickerRange();updateStartDateRange();});
    document.getElementById("generatorForm").addEventListener("submit",(e)=>{
      e.preventDefault();
      const f=e.currentTarget;
      if(!f.checkValidity()){f.classList.add("was-validated");return;}
      generateTable();
    });
    document.getElementById("generatePDF").addEventListener("click", downloadPDF);
    document.getElementById("sendPDFEmail").addEventListener("click", sendPDFEmail);
  });
})();
</script>
</body>
</html>
