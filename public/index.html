<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<title>Generator Godzin Emerlog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<style>
:root{
  --ink:#111; --muted:#555; --grid:#000;
  --off-bg:#ffcccc; --off-ink:#a00;
  --thead-bg:#fff; --paper:#fff;
}
html,body{background:#f5f5f7;color:var(--ink)}
.container{max-width:1040px}
header{background:#fff;border-bottom:1px solid #e5e7eb}
.brand{font-weight:700}

.card{border:1px solid #e5e7eb;border-radius:12px}
.card-header{background:#fff;border-bottom:1px solid #e5e7eb;font-weight:600}

/* ————— TABELA (jak na podglądzie) ————— */
.sheet-wrap{background:var(--paper);border:1px solid var(--grid);border-radius:10px;overflow:hidden}
.sheet-head{padding:16px 18px 8px 18px;border-bottom:1px solid var(--grid)}
.sheet-head .mname{font-size:24px;font-weight:800;margin:0}
.sheet-head .person{font-size:18px;font-weight:700;margin:2px 0 0}
.sheet-head .ctype{font-size:12px;color:var(--muted);margin:0}

.table-times{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  background:var(--paper);
}
.table-times th,.table-times td{
  border:1px solid var(--grid);
  padding:8px 10px;
  text-align:center;
  vertical-align:middle;
  background:#fff;
  font-size:14px;
}
.table-times thead th{
  background:var(--thead-bg);
  font-weight:700;
}
.table-times .col-day{width:54px}
.table-times .col-date{text-align:left}
.table-times .col-start,.table-times .col-end{width:100px}
.table-times .col-hours{width:90px}
.table-times .col-sign{width:140px}
.table-times .col-leave{width:110px}
.mono{font-variant-numeric:tabular-nums}

/* Dni wolne – mocne czerwone tło i pogrubienie */
.table-times tr.off td{
  background:var(--off-bg);
  color:var(--off-ink);
  font-weight:700;
}

/* Wiersz sumy */
.table-times tfoot td{
  font-weight:800;
  background:#fff;
}

/* Druk */
@media print{
  body{background:#fff}
  .card,.sheet-wrap{box-shadow:none}
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
}
</style>
</head>
<body>
<header>
  <div class="container py-3 d-flex justify-content-between align-items-center">
    <div class="brand h5 m-0"><i class="fas fa-clock me-2 text-primary"></i>Generator Godzin Emerlog</div>
  </div>
</header>

<main class="container py-4">
  <section class="card mb-4">
    <div class="card-header py-3 px-4">Parametry</div>
    <div class="card-body p-4">
      <form id="generatorForm" novalidate>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="name">Imię i nazwisko *</label>
            <input class="form-control" id="name" required>
            <div class="invalid-feedback">Wpisz imię i nazwisko.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="month">Miesiąc *</label>
            <select class="form-select" id="month" required>
              <option value="">Wybierz…</option>
              <option value="1">Styczeń</option><option value="2">Luty</option><option value="3">Marzec</option>
              <option value="4">Kwiecień</option><option value="5">Maj</option><option value="6">Czerwiec</option>
              <option value="7">Lipiec</option><option value="8">Sierpień</option><option value="9">Wrzesień</option>
              <option value="10">Październik</option><option value="11">Listopad</option><option value="12">Grudzień</option>
            </select>
            <div class="invalid-feedback">Wybierz miesiąc.</div>
          </div>
          <div class="col-md-2">
            <label class="form-label" for="year">Rok *</label>
            <input class="form-control" type="number" id="year" min="2000" value="2025" required>
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">Rodzaj umowy</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="contractType" id="contractZlecenie" value="zlecenie" checked>
              <label class="form-check-label" for="contractZlecenie">Umowa zlecenie</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="contractType" id="contractPraca" value="praca">
              <label class="form-check-label" for="contractPraca">Umowa o pracę (pełny etat)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="contractType" id="contract34" value="praca3/4">
              <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
            </div>
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-3 align-items-end">
          <div class="col-md-6" id="hoursGroup">
            <label class="form-label" for="hours">Łączna liczba godzin (zlecenie) *</label>
            <input class="form-control" type="number" id="hours" min="30" step="1">
            <div class="form-check mt-2" id="partialMonthWrap">
              <input class="form-check-input" type="checkbox" id="partialMonth">
              <label class="form-check-label" for="partialMonth">Niepełny miesiąc</label>
            </div>
            <div class="row mt-2" id="partialMonthStartRow" style="display:none;">
              <div class="col-md-8">
                <label class="form-label" for="startDate">Data rozpoczęcia</label>
                <input class="form-control" type="date" id="startDate">
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Dodatkowe dni wolne</label>
            <div class="row g-2">
              <div class="col-md-6"><input class="form-control" type="date" id="holidayPicker"></div>
              <div class="col-md-4">
                <select class="form-select" id="holidayTypeSelect">
                  <option value="Inne">Inne</option>
                  <option value="Urlop wypoczynkowy">Urlop wypoczynkowy</option>
                  <option value="Urlop okolicznościowy">Urlop okolicznościowy</option>
                  <option value="Zwolnienie lekarskie (L4)">Zwolnienie lekarskie (L4)</option>
                  <option value="Bezpłatny">Urlop bezpłatny</option>
                  <option value="Odbiór">Odbiór</option>
                </select>
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-outline-secondary" type="button" id="addHoliday"><i class="fa fa-plus"></i></button>
              </div>
            </div>
            <ul class="small mt-2" id="holidaysList"></ul>

            <div class="form-check mt-2" id="randomHolidaysGroup">
              <input class="form-check-input" type="checkbox" id="randomHolidays">
              <label class="form-check-label" for="randomHolidays">Losowe dni wolne (~35%)</label>
            </div>
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-primary" type="submit"><i class="fa fa-table me-1"></i>Generuj tabelę</button>
          <button class="btn btn-success" type="button" id="generatePDF" disabled><i class="fa-regular fa-file-pdf me-1"></i>Pobierz PDF</button>
        </div>
      </form>
    </div>
  </section>

  <section class="sheet-wrap" id="resultWrap" style="display:none;">
    <div class="sheet-head">
      <h2 class="mname" id="mname"></h2>
      <p class="person" id="pname"></p>
      <p class="ctype" id="ctype"></p>
    </div>
    <div id="output"></div>
  </section>

  <footer class="text-center pt-4 pb-2 small text-secondary">© 2025 Emerlog</footer>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(()=>{"use strict";
const MIN_START=7, MAX_END=20;
const MIN_ZL_FULL=4, MAX_ZL_FULL=16;
const MIN_ZL_PART=1, MAX_ZL_PART=16;
const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
window.customHolidays=[];

function toISO(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`;}
function easterSunday(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,mo-1,day);}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function plHolidays(year){const fixed=["01-01","01-06","05-01","05-03","08-15","11-01","11-11","12-25","12-26"].map(md=>`${year}-${md}`);const e=easterSunday(year);return new Set([...fixed,toISO(addDays(e,1)),toISO(addDays(e,60))]);}
function isWeekend(d){const w=d.getDay();return w===0||w===6;}
function ri(a,b){a=Math.ceil(a);b=Math.floor(b);return Math.floor(Math.random()*(b-a+1))+a;}
function drawHours(min,max){const buckets=[{lo:Math.max(min,4),hi:Math.min(max,6),w:3},{lo:Math.max(min,7),hi:Math.min(max,9),w:6},{lo:Math.max(min,10),hi:Math.min(max,12),w:3},{lo:Math.max(min,13),hi:Math.min(max,16),w:1}].filter(b=>b.lo<=b.hi);const tot=buckets.reduce((a,b)=>a+b.w,0);let r=Math.random()*tot,p=buckets[0];for(const b of buckets){r-=b.w;if(r<=0){p=b;break;}}return ri(p.lo,p.hi);}
function distribute(total,n,min,max){
  if(n===0) return total===0?[]:null;
  const minAll=min*n,maxAll=max*n;
  if(total<minAll){alert(`Za mało godzin (min. ${minAll}).`);return null;}
  if(total>maxAll){alert(`Za dużo godzin (max. ${maxAll}).`);return null;}
  let arr=Array.from({length:n},()=>drawHours(min,max));
  let sum=arr.reduce((a,b)=>a+b,0);
  const inc=()=>{const id=arr.map((v,i)=>[v,i]).filter(([v])=>v<max).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); if(!id.length) return false; arr[id[ri(0,Math.min(3,id.length-1))]]++; return true;};
  const dec=()=>{const id=arr.map((v,i)=>[v,i]).filter(([v])=>v>min).sort((a,b)=>b[0]-a[0]).map(x=>x[1]); if(!id.length) return false; arr[id[ri(0,Math.min(3,id.length-1))]]--; return true;};
  while(sum<total){ if(!inc()) break; sum++; }
  while(sum>total){ if(!dec()) break; sum--; }
  for(let i=1;i<n;i++){ if(arr[i]===arr[i-1]){ if(arr[i]<max){arr[i]++;sum++;} else if(arr[i-1]>min){arr[i-1]--;sum--;} } }
  while(sum<total){ if(!inc()) break; sum++; }
  while(sum>total){ if(!dec()) break; sum--; }
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  return arr;
}
function weightedStart(h){ if(h>=12){ if(Math.random()<.7) return ri(7,9); return ri(9,11);} if(h>=8){ if(Math.random()<.6) return ri(8,10); return ri(10,12);} return ri(7,13); }
function assignTimes(days, hoursArr){
  let prev=null;
  for(let i=0;i<days.length;i++){
    const h=hoursArr[i]; let s=weightedStart(h); if(s+h>MAX_END) s=Math.max(MIN_START,MAX_END-h);
    let e=s+h; if(e>MAX_END){ e=MAX_END; s=e-h; if(s<MIN_START) s=MIN_START; }
    if(prev!==null && s===prev){ if(e<20){s++;e++;} else if(s>7){s--;e--;} }
    days[i].hours=h; days[i].start=s+":00"; days[i].end=e+":00"; prev=s;
  }
}
function applyRandomOff(list){
  const idx=list.map((d,i)=>d.isWorkingDay?i:-1).filter(i=>i>=0);
  if(idx.length<3) return;
  let toDrop=Math.max(1,Math.round(idx.length*0.35));
  for(let i=idx.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[idx[i],idx[j]]=[idx[j],idx[i]];}
  for(let k=0;k<toDrop;k++){ list[idx[k]].isWorkingDay=false; list[idx[k]].holidayType="-"; }
}
function chooseWorkDays(total,wd,min,max){
  const minK=Math.ceil(total/max), maxK=Math.floor(total/min);
  if(minK>wd) return null;
  const k=Math.max(minK, Math.min(maxK, Math.round(total/8.5)));
  return Math.min(wd, Math.max(minK, k));
}
function selectEven(len,k){ const set=new Set(), step=len/k; for(let j=0;j<k;j++) set.add(Math.min(len-1,Math.round(j*step))); while(set.size<k) set.add(Math.floor(Math.random()*len)); return Array.from(set).sort((a,b)=>a-b); }

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("generatorForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const f=e.currentTarget;
    if(!f.checkValidity()){ f.classList.add("was-validated"); return; }
    generateTable();
  });
  document.querySelectorAll('input[name="contractType"]').forEach(r=>r.addEventListener("change",onContractChange));
  document.getElementById("addHoliday").addEventListener("click", ()=>{
    const d=document.getElementById("holidayPicker").value;
    const t=document.getElementById("holidayTypeSelect").value;
    if(!d){alert("Wybierz datę.");return;}
    if(!window.customHolidays.find(x=>x.date===d)) window.customHolidays.push({date:d,type:t}); else alert("Ta data już jest dodana.");
    renderHolidays();
  });
  document.getElementById("partialMonth").addEventListener("change", function(){
    const row=document.getElementById("partialMonthStartRow");
    if(this.checked){ document.getElementById("hours").removeAttribute("min"); row.style.display="block"; }
    else{ document.getElementById("hours").min="30"; row.style.display="none"; document.getElementById("startDate").value=""; }
  });
  document.getElementById("generatePDF").addEventListener("click", downloadPDF);
  document.getElementById("month").addEventListener("change",updateRanges);
  document.getElementById("year").addEventListener("change",updateRanges);
  onContractChange(); updateRanges();
});

function onContractChange(){
  const t=document.querySelector('input[name="contractType"]:checked').value;
  const hoursGroup=document.getElementById("hoursGroup");
  const hoursInput=document.getElementById("hours");
  const partialWrap=document.getElementById("partialMonthWrap");
  const randomGroup=document.getElementById("randomHolidaysGroup");
  if(t==="zlecenie"){
    hoursGroup.style.display="block"; hoursInput.required=true; hoursInput.min="30";
    partialWrap.style.display="block"; randomGroup.style.display="block";
  }else{
    hoursGroup.style.display="none"; hoursInput.required=false; hoursInput.removeAttribute("min");
    document.getElementById("partialMonth").checked=false;
    document.getElementById("partialMonthStartRow").style.display="none";
    partialWrap.style.display="none"; randomGroup.style.display="none";
  }
}
function updateRanges(){
  const m=+document.getElementById("month").value||0;
  const y=+document.getElementById("year").value||0;
  const h=document.getElementById("holidayPicker");
  const s=document.getElementById("startDate");
  if(!m||!y){ h?.removeAttribute("min");h?.removeAttribute("max"); s?.removeAttribute("min");s?.removeAttribute("max"); return;}
  const days=new Date(y,m,0).getDate(), mm=String(m).padStart(2,'0');
  const minD=`${y}-${mm}-01`, maxD=`${y}-${mm}-${String(days).padStart(2,'0')}`;
  if(h){h.min=minD;h.max=maxD;if(h.value&&(h.value<minD||h.value>maxD))h.value="";}
  if(s){s.min=minD;s.max=maxD;if(s.value&&(s.value<minD||s.value>maxD))s.value="";}
}
function renderHolidays(){
  const ul=document.getElementById("holidaysList"); ul.innerHTML="";
  window.customHolidays.forEach(item=>{
    const li=document.createElement("li"); li.textContent=item.date+" – "+item.type;
    const b=document.createElement("button"); b.className="btn btn-sm btn-outline-danger ms-2"; b.textContent="Usuń";
    b.onclick=()=>{window.customHolidays=window.customHolidays.filter(x=>x!==item);renderHolidays();};
    li.appendChild(b); ul.appendChild(li);
  });
}

function generateTable(){
  const fullName=document.getElementById("name").value.trim();
  const m=+document.getElementById("month").value;
  const y=+document.getElementById("year").value;
  const contract=document.querySelector('input[name="contractType"]:checked').value;
  const isPartial=document.getElementById("partialMonth").checked;
  const startDateVal=document.getElementById("startDate").value;
  const addRandom=document.getElementById("randomHolidays").checked;

  if(contract==="zlecenie"&&isPartial&&!startDateVal){ alert("Wybierz datę startu."); return; }

  const holidays=plHolidays(y);
  const daysCount=new Date(y,m,0).getDate();
  let dayData=[];
  for(let d=1; d<=daysCount; d++){
    const dateObj=new Date(y,m-1,d);
    const iso=toISO(dateObj);
    const weekend=isWeekend(dateObj);
    const publicH=holidays.has(iso);
    const custom=window.customHolidays.find(x=>x.date===iso);
    const holType=publicH?"Święto":(custom?"-":"");
    const isWork=(!weekend && !publicH && !custom);
    dayData.push({day:d,date:dateObj,isWorkingDay:isWork,holidayType:holType,hours:0,start:"-",end:"-"});
  }

  if(contract==="zlecenie" && isPartial && startDateVal){
    const startObj=new Date(startDateVal+"T00:00:00");
    dayData.forEach(dd=>{ if(dd.date<startObj && dd.isWorkingDay){ dd.isWorkingDay=false; dd.holidayType="-"; } });
  }
  if(contract==="zlecenie" && addRandom && !isPartial){ applyRandomOff(dayData); }

  let working=dayData.filter(x=>x.isWorkingDay);

  if(contract==="praca"){
    working.forEach(d=>{ d.hours=8; d.start="08:00"; d.end="16:00"; });
  }else if(contract==="praca3/4"){
    working.forEach(d=>{ d.hours=6; d.start="08:00"; d.end="14:00"; });
  }else{
    const total=+document.getElementById("hours").value||0;
    if(!isPartial && total<30){ alert("Minimalnie 30 h w trybie pełnym."); return; }
    if(isPartial){
      if(working.length===0){ alert("Brak dni roboczych od daty startu."); return; }
      const W=working.length, minReq=Math.max(1, W-2);
      if(total<minReq){ alert(`Za mało godzin. Minimum ${minReq} h.`); return; }
      const fill=Math.min(W,total);
      if(fill<W){
        const toSkip=W-fill;
        for(let s=W-toSkip;s<W;s++){ working[s].isWorkingDay=false; }
        working=working.slice(0,fill);
      }
      const arr=distribute(total, working.length, MIN_ZL_PART, MAX_ZL_PART);
      if(!arr) return; assignTimes(working, arr);
    }else{
      const idx=dayData.map((d,i)=>d.isWorkingDay?i:-1).filter(i=>i>=0);
      const k=chooseWorkDays(total, idx.length, MIN_ZL_FULL, MAX_ZL_FULL);
      if(k===null){ alert(`Za dużo godzin (${total}) na dostępne dni (${idx.length}).`); return; }
      const picksRel=selectEven(idx.length, k);
      const picksAbs=new Set(picksRel.map(i=>idx[i]));
      for(const i of idx){ if(!picksAbs.has(i)){ dayData[i].isWorkingDay=false; dayData[i].holidayType="-"; } }
      working=dayData.filter(x=>x.isWorkingDay);
      const arr=distribute(total, working.length, MIN_ZL_FULL, MAX_ZL_FULL);
      if(!arr) return; assignTimes(working, arr);
    }
  }

  // Nagłówki jak na zrzucie
  document.getElementById("mname").textContent = `${monthNames[m-1]} ${y}`;
  document.getElementById("pname").textContent = fullName;
  document.getElementById("ctype").textContent =
     (contract==="praca")?"Umowa o pracę":
     (contract==="praca3/4")?"Umowa o pracę (3/4 etatu)":"Umowa zlecenie";

  // Nazwisko do kolumny „Podpis zleceniobiorcy”
  const lastName = fullName.trim().split(/\s+/).slice(1).join(" ") || fullName.trim();

  const rows = dayData.map(inf=>{
    const dd=String(inf.day).padStart(2,'0'), mm=String(m).padStart(2,'0'), yyyy=y;
    const wkd=inf.date.toLocaleString('pl-PL',{weekday:'short'});
    if(inf.isWorkingDay){
      return `<tr>
        <td class="col-day mono">${inf.day}</td>
        <td class="col-date">${dd}.${mm}.${yyyy} (${wkd})</td>
        <td class="col-start mono">${inf.start}</td>
        <td class="col-end mono">${inf.end}</td>
        <td class="col-hours mono">${inf.hours}</td>
        <td class="col-sign">${lastName}</td>
        <td class="col-sign"></td>
        <td class="col-leave">-</td>
      </tr>`;
    }
    const shown = (inf.holidayType==="Święto") ? "Święto" : "-";
    return `<tr class="off">
      <td class="col-day mono">${inf.day}</td>
      <td class="col-date">${dd}.${mm}.${yyyy} (${wkd})</td>
      <td class="col-start mono">-</td>
      <td class="col-end mono">-</td>
      <td class="col-hours mono">0</td>
      <td class="col-sign">${lastName}</td>
      <td class="col-sign"></td>
      <td class="col-leave">${shown}</td>
    </tr>`;
  });

  const sum=dayData.filter(d=>d.isWorkingDay).reduce((a,b)=>a+b.hours,0);
  const table = `
    <table class="table-times">
      <thead>
        <tr>
          <th class="col-day">Dzień</th>
          <th>Data</th>
          <th class="col-start">Godz. rozpoczęcia</th>
          <th class="col-end">Godz. zakończenia</th>
          <th class="col-hours">Suma godzin</th>
          <th class="col-sign">Podpis zleceniobiorcy</th>
          <th class="col-sign">Podpis zleceniodawcy</th>
          <th class="col-leave">Urlop</th>
        </tr>
      </thead>
      <tbody>${rows.join("")}</tbody>
      <tfoot>
        <tr>
          <td colspan="4">Suma</td>
          <td class="mono">${sum}</td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>`;
  document.getElementById("output").innerHTML=table;
  document.getElementById("resultWrap").style.display='block';
  document.getElementById("generatePDF").disabled=false;
  document.getElementById("generatorForm").classList.remove("was-validated");
}

async function downloadPDF(){
  try{
    const jsPDF=window.jspdf.jsPDF;
    const pdf=new jsPDF("portrait","pt","a4");
    const pageWidth=pdf.internal.pageSize.getWidth();
    const out=document.getElementById("resultWrap");
    const canvas=await html2canvas(out,{scale:1.6,useCORS:true,backgroundColor:"#ffffff"});
    const img=canvas.toDataURL("image/png");
    const w=pageWidth-40, h=canvas.height*(w/canvas.width);
    pdf.addImage(img,"PNG",20,20,w,h);
    pdf.save("Tabela_Godzinowa.pdf");
  }catch(e){console.error(e);alert("Nie udało się wygenerować PDF.");}
}
})();
</script>
</body>
</html>
