<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Generator Godzin Rmsped - Word-like Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- html2canvas + jspdf (do PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- docx (do Word) z poprawnego CDN JSDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.umd.js"></script>

  <style>
    body {
      background-color: #f9f9f9;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    .container {
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 1000px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #333;
    }
    .header p {
      font-size: 16px;
      color: #555;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    .card h5 {
      margin-bottom: 15px;
      font-weight: 600;
    }
    .instructions ul {
      list-style: none;
      padding-left: 0;
    }
    .instructions ul li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 25px;
    }
    .instructions ul li::before {
      content: "\f058";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      color: #0066cc;
      position: absolute;
      left: 0;
      top: -1px;
    }
    .form-group.required .form-label:after {
      content: "*";
      color: red;
      margin-left: 5px;
    }
    .form-text {
      font-size: 12px;
      color: #666;
    }
    .holidays-list li {
      margin-bottom: 5px;
    }
    .btn {
      transition: background-color 0.3s ease;
    }
    footer {
      margin-top: 40px;
      text-align: center;
      color: #777;
      font-size: 0.85em;
    }
    /* Stylizacja tabeli */
    .final-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .final-table th,
    .final-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    .final-table thead th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    /* Wyróżnienie dni niepracujących */
    .final-table .holiday td {
      background-color: #ffcccc;
      color: #a00;
      font-weight: bold;
    }
    /* Styl wniosku urlopowego */
    #vacationRequest {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      padding: 20px;
      border: 1px solid #000;
      margin-top: 20px;
    }
    .signatureName {
      font-family: "Arial", sans-serif;
      font-size: 24px;
      text-align: center;
      margin-bottom: 5px;
    }
    .signatureLine {
      margin: 0 auto;
      width: 200px;
      border: none;
      border-top: 1px solid #000;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Nagłówek -->
    <div class="header">
      <h1><i class="fas fa-clock"></i> Generator Godzin Rmsped</h1>
      <p>Wprowadź dane i wybierz rodzaj umowy.</p>
    </div>

    <!-- Instrukcja -->
    <div class="card mb-4">
      <h5><i class="fas fa-info-circle"></i> Instrukcja</h5>
      <div class="instructions">
        <ul>
          <li>Wybierz rodzaj umowy:
            <ul>
              <li><strong>Umowa zlecenie</strong> – godziny generowane losowo, <em>opcja "Losowe dni wolne" jest obowiązkowa</em>.</li>
              <li><strong>Umowa o pracę (pełny etat)</strong> – stałe godziny: 8:00–16:00.</li>
              <li><strong>Umowa o pracę (3/4 etatu)</strong> – stałe godziny: 8:00–14:00.</li>
            </ul>
          </li>
          <li>Dla umowy zlecenie wpisz łączną liczbę godzin – dla umów o pracę to pole jest ukryte.</li>
          <li>Wybierz miesiąc i rok oraz (opcjonalnie) dodaj ręcznie dni wolne.</li>
          <li>Opcja „Dodaj losowo dni wolne”:
            <ul>
              <li><em>Obowiązkowa</em> przy umowie zleceniu (zaznaczona na stałe).</li>
              <li><em>Dobrowolna</em> przy umowie o pracę (pełny etat) i 3/4 etatu.</li>
            </ul>
          </li>
          <li>Dla umowy o pracę (3/4 etatu) zaznacz opcję „Wygeneruj wniosek urlopowy”, aby w PDF-ie na osobnej stronie pojawił się wniosek urlopowy (dni wolne będą prezentowane jako zakresy, np. 04.05.2025 – 06.05.2025).</li>
          <li>Kliknij „Generuj tabelę” i pobierz PDF lub wyślij Word (Word ma mniejszy rozmiar!).</li>
        </ul>
      </div>
    </div>

    <!-- Formularz -->
    <div class="card mb-4">
      <form id="generatorForm" novalidate>
        <!-- Wybór rodzaju umowy -->
        <div class="mb-3">
          <label class="form-label">Rodzaj umowy</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contractZlecenie" value="zlecenie" checked>
            <label class="form-check-label" for="contractZlecenie">Umowa zlecenie</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contractPraca" value="praca">
            <label class="form-check-label" for="contractPraca">Umowa o pracę (pełny etat)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contract34" value="praca3/4">
            <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
          </div>
        </div>

        <!-- Checkbox dla wniosku urlopowego – widoczny tylko przy umowie 3/4 etatu -->
        <div class="mb-3 form-check" id="vacationRequestGroup" style="display:none;">
          <input type="checkbox" class="form-check-input" id="generateVacation">
          <label class="form-check-label" for="generateVacation">Wygeneruj wniosek urlopowy</label>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3 form-group required">
            <label for="name" class="form-label">Imię i nazwisko</label>
            <input type="text" class="form-control" id="name" required>
            <div class="invalid-feedback">Wpisz imię i nazwisko.</div>
          </div>
          <!-- Pole "Łączna liczba godzin" – widoczne tylko przy umowie zlecenie -->
          <div class="col-md-6 mb-3 form-group required" id="hoursGroup">
            <label for="hours" class="form-label">Łączna liczba godzin</label>
            <input type="number" class="form-control" id="hours" min="1" required>
            <div class="invalid-feedback">Wpisz liczbę godzin (min 1).</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3 form-group required">
            <label for="month" class="form-label">Miesiąc</label>
            <select id="month" class="form-select" required>
              <option value="">Wybierz...</option>
              <option value="1">Styczeń</option>
              <option value="2">Luty</option>
              <option value="3">Marzec</option>
              <option value="4">Kwiecień</option>
              <option value="5">Maj</option>
              <option value="6">Czerwiec</option>
              <option value="7">Lipiec</option>
              <option value="8">Sierpień</option>
              <option value="9">Wrzesień</option>
              <option value="10">Październik</option>
              <option value="11">Listopad</option>
              <option value="12">Grudzień</option>
            </select>
            <div class="invalid-feedback">Wybierz miesiąc.</div>
          </div>
          <div class="col-md-4 mb-3 form-group required">
            <label for="year" class="form-label">Rok</label>
            <input type="number" class="form-control" id="year" min="1900" value="2025" required>
            <div class="invalid-feedback">Podaj rok (np. 2025).</div>
          </div>
          <div class="col-md-4 mb-3">
            <small class="form-text">Praca kończy się zawsze przed 20:00.</small>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Dodatkowe dni wolne</label>
          <div class="input-group">
            <input type="date" class="form-control" id="holidayPicker">
            <button type="button" class="btn btn-secondary" id="addHoliday">Dodaj wolne</button>
          </div>
          <ul class="holidays-list" id="holidaysList"></ul>
        </div>
        
        <!-- Opcja "losowe dni wolne" – zawsze widoczna, ale wymuszone 'checked' przy zleceniu -->
        <div class="mb-3 form-check" id="randomHolidaysGroup">
          <input type="checkbox" class="form-check-input" id="randomHolidays">
          <label class="form-check-label" for="randomHolidays">Dodaj losowo dni wolne</label>
        </div>

        <button type="submit" class="btn btn-primary">Generuj tabelę</button>
      </form>
    </div>

    <!-- Wyświetlenie harmonogramu -->
    <div id="output" class="table-responsive"></div>
    <!-- Wniosek urlopowy – ukryty, a jego zawartość zostanie wykorzystana do PDF (druga strona) -->
    <div id="vacationRequest" style="display:none;"></div>
    <div id="exportButtons" class="mt-3" style="display:none;">
      <button id="generatePDF" class="btn btn-success me-2"><i class="far fa-file-pdf"></i> Pobierz jako PDF</button>
      <button id="generateWord" class="btn btn-primary"><i class="far fa-file-word"></i> Wyślij Word e-mailem</button>
    </div>
  </div>

  <footer>&copy; 2023 Emerlog</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***********************************************
     * KOD (taki sam jak w Rmsped Generator.html),
     * plus funkcja 'sendWord()' do wysłania DOCX.
     ***********************************************/

    // MAPA "PIERWSZYCH DNI ROBOCZYCH" DLA UMOWY ZLECENIE (opcjonalne)
    const FIRST_WORKING_DAYS = {
      // np. 2025: { 2:3, 3:3, 4:1, 5:5, ... }
      // ...
    };

    // Dane miesięczne – (przy zleceniu użytkownik wpisuje liczbę godzin samodzielnie)
    const monthlyData2025 = {
      1:  { totalHours: 168, workingDays: 21, freeDays: 10 },
      2:  { totalHours: 160, workingDays: 20, freeDays: 8 },
      3:  { totalHours: 168, workingDays: 21, freeDays: 10 },
      4:  { totalHours: 168, workingDays: 21, freeDays: 9 },
      5:  { totalHours: 160, workingDays: 20, freeDays: 11 },
      6:  { totalHours: 160, workingDays: 20, freeDays: 10 },
      7:  { totalHours: 184, workingDays: 23, freeDays: 8 },
      8:  { totalHours: 160, workingDays: 20, freeDays: 11 },
      9:  { totalHours: 176, workingDays: 22, freeDays: 8 },
      10: { totalHours: 184, workingDays: 23, freeDays: 8 },
      11: { totalHours: 144, workingDays: 18, freeDays: 12 },
      12: { totalHours: 168, workingDays: 21, freeDays: 10 }
    };

    window.customHolidays = [];
    window.randomFreeDaysAdded = [];

    const MAX_HOURS_PER_DAY = 12;
    const MIN_HOURS_PER_DAY = 4;

    // Obsługa zmiany rodzaju umowy
    document.querySelectorAll('input[name="contractType"]').forEach(input => {
      input.addEventListener("change", () => {
        const type = document.querySelector('input[name="contractType"]:checked').value;
        if (type === "praca" || type === "praca3/4") {
          document.getElementById("hoursGroup").style.display = "none";
          document.getElementById("hours").required = false;
          document.getElementById("vacationRequestGroup").style.display = (type === "praca3/4") ? "block" : "none";

          document.getElementById("randomHolidays").disabled = false;
          document.getElementById("randomHolidays").checked = false;
        } else {
          // "zlecenie"
          document.getElementById("hoursGroup").style.display = "block";
          document.getElementById("hours").required = true;
          document.getElementById("vacationRequestGroup").style.display = "none";

          // "Losowe dni wolne" musi być zaznaczone i zablokowane
          document.getElementById("randomHolidays").checked = true;
          document.getElementById("randomHolidays").disabled = true;
        }
      });
    });

    function formatDate(date) {
      const d = date.getDate().toString().padStart(2, '0');
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const y = date.getFullYear();
      return `${d}.${m}.${y}`;
    }

    function groupDates(dates) {
      if (!dates.length) return [];
      let groups = [];
      let groupStart = dates[0];
      let groupEnd = dates[0];
      for (let i = 1; i < dates.length; i++) {
        let current = dates[i];
        // różnica 1 doby => 86400000
        if (current - groupEnd === 86400000) {
          groupEnd = current;
        } else {
          groups.push({ start: groupStart, end: groupEnd });
          groupStart = current;
          groupEnd = current;
        }
      }
      groups.push({ start: groupStart, end: groupEnd });
      return groups;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("generatorForm");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!form.checkValidity()) {
          e.stopPropagation();
        } else {
          generateTable();
        }
        form.classList.add("was-validated");
      });

      // Obsługa dodawania dni wolnych ręcznie
      const addHolidayBtn = document.getElementById("addHoliday");
      const holidayPicker = document.getElementById("holidayPicker");
      const holidaysListEl = document.getElementById("holidaysList");

      addHolidayBtn.addEventListener("click", () => {
        const selDate = holidayPicker.value;
        if (!selDate) {
          alert("Wybierz datę!");
          return;
        }
        if (!window.customHolidays.includes(selDate)) {
          window.customHolidays.push(selDate);
          renderHolidays();
        }
      });

      function renderHolidays() {
        holidaysListEl.innerHTML = "";
        window.customHolidays.forEach(h => {
          const li = document.createElement("li");
          li.textContent = h;
          const btn = document.createElement("button");
          btn.classList.add("btn", "btn-sm", "btn-danger", "ms-2");
          btn.textContent = "Usuń";
          btn.addEventListener("click", () => {
            window.customHolidays = window.customHolidays.filter(x => x !== h);
            renderHolidays();
          });
          li.appendChild(btn);
          holidaysListEl.appendChild(li);
        });
      }

      // Ustawianie min/max w datePickerze (holidayPicker)
      const monthEl = document.getElementById("month");
      const yearEl = document.getElementById("year");

      monthEl.addEventListener("change", updateHolidayPickerRange);
      yearEl.addEventListener("change", updateHolidayPickerRange);

      function updateHolidayPickerRange() {
        const mVal = parseInt(monthEl.value, 10);
        const yVal = parseInt(yearEl.value, 10);
        if (!mVal || !yVal) {
          holidayPicker.removeAttribute("min");
          holidayPicker.removeAttribute("max");
          return;
        }
        const daysInMonth = new Date(yVal, mVal, 0).getDate();
        const mm = String(mVal).padStart(2, '0');
        const minDate = `${yVal}-${mm}-01`;
        const maxDate = `${yVal}-${mm}-${daysInMonth}`;
        holidayPicker.setAttribute("min", minDate);
        holidayPicker.setAttribute("max", maxDate);
        if (holidayPicker.value) {
          if (holidayPicker.value < minDate || holidayPicker.value > maxDate) {
            holidayPicker.value = "";
          }
        }
      }
    });

    const fixedHolidays = [
      "01-01", "06-01", "20-04", "21-04",
      "01-05", "03-05", "08-06", "19-06",
      "15-08", "01-11", "11-11",
      "25-12", "26-12"
    ];

    function isHoliday(day, month, year) {
      const yyyy = String(year).padStart(4, "0");
      const mm = String(month).padStart(2, '0');
      const dd = String(day).padStart(2, '0');
      const fullDate = `${yyyy}-${mm}-${dd}`;
      const shortDate = `${dd}-${mm}`;
      if (window.customHolidays.includes(fullDate)) return true;
      if (fixedHolidays.includes(shortDate)) return true;
      return false;
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function distributeHours(totalHours, daysCount) {
      if (daysCount === 0) return null;
      const maxPossible = MAX_HOURS_PER_DAY * daysCount;
      const minPossible = MIN_HOURS_PER_DAY * daysCount;
      if (totalHours > maxPossible) {
        alert(`Za dużo godzin (max ${maxPossible})!`);
        return null;
      }
      if (totalHours < minPossible) {
        alert(`Za mało godzin (min ${minPossible})!`);
        return null;
      }
      let arr = new Array(daysCount).fill(MIN_HOURS_PER_DAY);
      let leftover = totalHours - (daysCount * MIN_HOURS_PER_DAY);
      let base = Math.floor(leftover / daysCount);
      let rem = leftover % daysCount;
      for (let i = 0; i < daysCount; i++) {
        arr[i] += base;
      }
      let idxs = [...Array(daysCount).keys()];
      shuffleArray(idxs);
      for (let i = 0; i < rem; i++) {
        for (let j = 0; j < daysCount; j++) {
          if (arr[idxs[j]] < MAX_HOURS_PER_DAY) {
            arr[idxs[j]]++;
            break;
          }
        }
      }
      let adjustments = Math.min(Math.ceil(daysCount * 0.3), 8);
      for (let k = 0; k < adjustments; k++) {
        let dayIndex = Math.floor(Math.random() * daysCount);
        let sign = (Math.random() < 0.5 ? -1 : 1);
        let newVal = arr[dayIndex] + sign;
        if (newVal >= MIN_HOURS_PER_DAY && newVal <= MAX_HOURS_PER_DAY) {
          arr[dayIndex] = newVal;
        }
      }
      let diff = totalHours - arr.reduce((a, b) => a + b, 0);
      if (diff !== 0) {
        for (let i = 0; i < daysCount && diff !== 0; i++) {
          if (diff > 0 && arr[i] < MAX_HOURS_PER_DAY) {
            let canAdd = Math.min(diff, MAX_HOURS_PER_DAY - arr[i]);
            arr[i] += canAdd;
            diff -= canAdd;
          } else if (diff < 0 && arr[i] > MIN_HOURS_PER_DAY) {
            let canRem = Math.min(Math.abs(diff), arr[i] - MIN_HOURS_PER_DAY);
            arr[i] -= canRem;
            diff += canRem;
          }
        }
      }
      let finalSum = arr.reduce((a, b) => a + b, 0);
      if (finalSum !== totalHours) {
        alert("Nie udało się dopasować godzin do wskazanej sumy.");
        return null;
      }
      return arr;
    }

    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      if (max < min) return min;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateTable() {
      window.randomFreeDaysAdded = [];
      const fullName = document.getElementById("name").value.trim();
      const monthVal = parseInt(document.getElementById("month").value, 10);
      const yearVal = parseInt(document.getElementById("year").value, 10);
      const addRandom = document.getElementById("randomHolidays").checked;
      const contractType = document.querySelector('input[name="contractType"]:checked').value;
      if (!fullName || !monthVal || !yearVal) {
        alert("Proszę wypełnić wszystkie wymagane pola!");
        return;
      }
      
      let totalHours;
      const monthNames = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];
      const daysInMonth = new Date(yearVal, monthVal, 0).getDate();
      let dayData = [];
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(yearVal, monthVal - 1, d);
        const isWeekend = [0, 6].includes(dateObj.getDay());
        const holiday = isHoliday(d, monthVal, yearVal);
        dayData.push({
          day: d,
          date: dateObj,
          isWorkingDay: (!isWeekend && !holiday),
          hours: 0,
          start: "-",
          end: "-",
          randomHoliday: false
        });
      }
      
      // UMOWA ZLECENIE + "losowe dni wolne"
      if (contractType === "zlecenie" && addRandom) {
        const freeDaysPattern = [0, 1, 3, 1, 0, 0];
        let grouped = {};
        dayData.forEach(day => {
          const week = Math.floor((day.day - 1) / 7) + 1;
          if (!grouped[week]) grouped[week] = [];
          grouped[week].push(day);
        });
        Object.keys(grouped).forEach(weekKey => {
          const weekDays = grouped[weekKey];
          const workingInWeek = weekDays.filter(d => d.isWorkingDay);
          let required = freeDaysPattern[parseInt(weekKey) - 1] || 0;
          required = Math.min(required, workingInWeek.length);
          if (required > 0) {
            const shuffled = workingInWeek.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, required);
            selected.forEach(day => {
              day.isWorkingDay = false;
              day.hours = 0;
              day.start = "-";
              day.end = "-";
              day.randomHoliday = true;
              window.randomFreeDaysAdded.push(day);
            });
          }
        });
      }
      
      let workingDays = dayData.filter(d => d.isWorkingDay);
      
      if (contractType === "praca") {
        workingDays.forEach(day => {
          day.hours = 8;
          day.start = "8:00";
          day.end = "16:00";
        });
        totalHours = workingDays.length * 8;
      }
      else if (contractType === "praca3/4") {
        workingDays.forEach(day => {
          day.hours = 6;
          day.start = "8:00";
          day.end = "14:00";
        });
        totalHours = workingDays.length * 6;
      }
      else if (contractType === "zlecenie") {
        totalHours = parseInt(document.getElementById("hours").value, 10);
        let hoursArray = distributeHours(totalHours, workingDays.length);
        if (!hoursArray) return;
        for (let i = 0; i < workingDays.length; i++) {
          let wd = workingDays[i];
          let h = hoursArray[i];
          let maxStart = 20 - h;
          let sH = getRandomInt(6, maxStart);
          let eH = sH + h;
          if (eH > 20) {
            alert(`Dzień ${wd.day}: koniec pracy po 20:00!`);
            return;
          }
          wd.hours = h;
          wd.start = sH + ":00";
          wd.end = eH + ":00";
        }
        let finalSum = workingDays.reduce((acc, w) => acc + w.hours, 0);
        if (finalSum !== totalHours) {
          alert(`Finalna suma godzin to ${finalSum}, a zadano ${totalHours}. Spróbuj mniejszą liczbę godzin.`);
          return;
        }
      }
      
      // Tworzymy finalną tabelę
      const nameParts = fullName.split(/\s+/);
      const lastName = nameParts.slice(1).join(" ");
      const rows = dayData.map(dInfo => {
        const dd = String(dInfo.day).padStart(2, '0');
        const mm = String(monthVal).padStart(2, '0');
        const yyyy = yearVal;
        const weekday = dInfo.date.toLocaleString('pl-PL', { weekday: 'short' });
        if (dInfo.isWorkingDay && dInfo.hours > 0) {
          return `<tr>
            <td>${dInfo.day}</td>
            <td>${dd}.${mm}.${yyyy} (${weekday})</td>
            <td>${dInfo.start}</td>
            <td>${dInfo.end}</td>
            <td>${dInfo.hours}</td>
            <td>${lastName}</td>
            <td></td>
          </tr>`;
        } else {
          // Dzień wolny
          return `<tr class="holiday">
            <td>${dInfo.day}</td>
            <td>${dd}.${mm}.${yyyy} (${weekday})</td>
            <td>-</td>
            <td>-</td>
            <td>0</td>
            <td>${lastName}</td>
            <td></td>
          </tr>`;
        }
      });

      const sumOfHours = workingDays.reduce((acc, d) => acc + d.hours, 0);
      rows.push(`
        <tr class="fw-bold">
          <td colspan="4">Suma godzin:</td>
          <td>${sumOfHours}</td>
          <td colspan="2"></td>
        </tr>
      `);

      let tableHTML = `
        <h3 class="mt-4">${monthNames[monthVal - 1]} ${yearVal}</h3>
        <h4>${fullName}</h4>
        <p><strong>Rodzaj umowy: ${
          contractType === "praca" ? "Umowa o pracę (8:00 - 16:00)" :
          contractType === "praca3/4" ? "Umowa o pracę (3/4 etatu, 8:00 - 14:00)" :
          "Umowa zlecenie"
        }</strong></p>
        <table class="final-table">
          <thead>
            <tr>
              <th>Dzień</th>
              <th>Data</th>
              <th>Godz. rozpoczęcia</th>
              <th>Godz. zakończenia</th>
              <th>Suma godzin</th>
              <th>Podpis zleceniobiorcy</th>
              <th>Podpis zleceniodawcy</th>
            </tr>
          </thead>
          <tbody>
            ${rows.join("")}
          </tbody>
        </table>
      `;
      
      // Druga strona (wniosek urlopowy)
      if (
        (contractType === "zlecenie" || (contractType === "praca3/4" && document.getElementById("generateVacation").checked))
        && window.randomFreeDaysAdded.length > 0
      ) {
        let sortedDates = window.randomFreeDaysAdded.map(day => day.date).sort((a, b) => a - b);
        let groups = groupDates(sortedDates);
        const vacationDaysCount = window.randomFreeDaysAdded.length;

        let requestDate = new Date();
        if (contractType === "zlecenie") {
          let firstDay = 1;
          if (FIRST_WORKING_DAYS[yearVal] && FIRST_WORKING_DAYS[yearVal][monthVal]) {
            firstDay = FIRST_WORKING_DAYS[yearVal][monthVal];
          }
          requestDate = new Date(yearVal, monthVal - 1, firstDay);
        }
        const requestDateFormatted = formatDate(requestDate);

        const vacationHTML = `
          <div id="vacationRequest" style="display:none; margin: 20px auto; max-width: 600px; font-family: Arial, sans-serif;">
            <img 
              src="https://lh3.googleusercontent.com/p/AF1QipMLjr7Z89mLaqKXBwtbab8UDG53ccbcEWvGqlpL=s1360-w1360-h1020"
              alt="Logo Emerlog"
              crossorigin="anonymous"
              style="display:block; margin: 0 auto 20px; max-height: 70px;"
            />
            <h3 style="text-align: center; font-weight: bold; margin-bottom: 20px;">
              WNIOSEK URLOPOWY
            </h3>
            <p><strong>Firma:</strong> Emerlog Sp. z o.o.</p>
            <p><strong>Imię i nazwisko wnioskującego:</strong> ${fullName}</p>
            <p><strong>Data wystawienia:</strong> ${requestDateFormatted}</p>
            <p><strong>Liczba dni wolnych:</strong> ${vacationDaysCount}</p>
            <p style="margin-top: 20px; margin-bottom: 10px;">
              Poniżej przedstawiam zakres dni urlopowych (ciągłe dni wolne zostały zgrupowane):
            </p>
            <ul style="margin-bottom: 20px; list-style-type: disc; padding-left: 20px;">
              ${
                groups.map(g => {
                  const start = formatDate(g.start);
                  const end = formatDate(g.end);
                  return `<li>${start === end ? start : `${start} – ${end}`}</li>`;
                }).join("")
              }
            </ul>
            <div style="text-align:center; margin-top:40px;">
              <p class="signatureName">${fullName}</p>
              <hr class="signatureLine">
            </div>
          </div>
        `;
        tableHTML += vacationHTML;
      } else {
        document.getElementById("vacationRequest").innerHTML = "";
      }
      
      document.getElementById("output").innerHTML = tableHTML;
      document.getElementById("exportButtons").style.display = "block";
      document.getElementById("generatePDF").onclick = downloadPDF;
      document.getElementById("generateWord").onclick = sendWord; // tu nasza nowa funkcja
    }

    // Generowanie PDF (2 strony)
    async function downloadPDF() {
      console.log("downloadPDF triggered");
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("portrait", "pt", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 20;

        // Logo
        const logoImageURL = "https://lh3.googleusercontent.com/p/AF1QipMLjr7Z89mLaqKXBwtbab8UDG53ccbcEWvGqlpL=s1360-w1360-h1020";
        const logoImg = new Image();
        logoImg.crossOrigin = "Anonymous";
        logoImg.src = logoImageURL;
        await new Promise(resolve => { logoImg.onload = resolve; });

        const desiredLogoWidth = 150;
        let desiredLogoHeight = logoImg.height * (desiredLogoWidth / logoImg.width);
        if (!desiredLogoHeight || desiredLogoHeight <= 0 || Number.isNaN(desiredLogoHeight)) {
          desiredLogoHeight = 50;
        }

        pdf.addImage(logoImg, "PNG", margin, margin, desiredLogoWidth, desiredLogoHeight);

        const outputEl = document.getElementById("output");
        if (!outputEl) {
          alert("Brak elementu #output do wygenerowania PDF.");
          return;
        }

        // Tabela
        const canvas = await html2canvas(outputEl, { scale: 2, useCORS: true, allowTaint: false });
        const tableImgData = canvas.toDataURL("image/png");
        const availableWidth = pageWidth - 2*margin;
        const availableHeight = pageHeight - (margin + desiredLogoHeight + margin);
        const ratio = Math.min(availableWidth / canvas.width, availableHeight / canvas.height);

        let finalW = canvas.width * ratio;
        let finalH = canvas.height * ratio;
        if (!finalW || finalW <= 0) finalW = canvas.width;
        if (!finalH || finalH <= 0) finalH = canvas.height;

        let posX_table = (pageWidth - finalW)/2;
        let posY_table = margin + desiredLogoHeight + 10;

        pdf.addImage(tableImgData, "PNG", posX_table, posY_table, finalW, finalH);

        // Druga strona (wniosek)
        const extraVacationEl = document.getElementById("vacationRequest");
        let extraVacationBackup = "";
        if (extraVacationEl) {
          extraVacationBackup = extraVacationEl.style.display;
          extraVacationEl.style.display = "block";
        }
        
        if (extraVacationEl && extraVacationEl.innerHTML.trim() !== "") {
          pdf.addPage();
          const canvasVacation = await html2canvas(extraVacationEl, { scale: 2, useCORS: true, allowTaint: false });
          const vacImgData = canvasVacation.toDataURL("image/png");

          const availW2 = pageWidth - 2*margin;
          const availH2 = pageHeight - 2*margin;
          const ratioVac = Math.min(availW2 / canvasVacation.width, availH2 / canvasVacation.height);

          let finalWV = canvasVacation.width * ratioVac;
          let finalHV = canvasVacation.height * ratioVac;
          if (!finalWV || finalWV <= 0) finalWV = canvasVacation.width;
          if (!finalHV || finalHV <= 0) finalHV = canvasVacation.height;

          let posXVac = (pageWidth - finalWV)/2;
          let posYVac = margin;

          pdf.addImage(vacImgData, "PNG", posXVac, posYVac, finalWV, finalHV);
        }

        pdf.save("Tabela_Godzinowa_Pion.pdf");

        if (extraVacationEl) {
          extraVacationEl.style.display = extraVacationBackup;
        }
      } catch (error) {
        console.error("Błąd podczas generowania PDF:", error);
        alert("Wystąpił błąd podczas generowania PDF. Sprawdź konsolę.");
      }
    }

    // Nowa funkcja: Wyślij Word e-mailem
    async function sendWord() {
      try {
        const name = document.getElementById("name").value.trim();
        if (!name) return alert("Wpisz imię i nazwisko.");

        const outputEl = document.getElementById("output");
        if (!outputEl || !outputEl.innerHTML.trim()) {
          return alert("Najpierw wygeneruj tabelę.");
        }

        // Zaciągamy docx obiekty
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, HeadingLevel } = window.docx;

        // Budujemy Document
        const doc = new Document({
          creator: "Emerlog Generator",
          description: "Wygenerowany harmonogram godzin (DOCX)",
        });

        // 1) Tytuł
        const title = new Paragraph({
          text: "Harmonogram godzin - " + name,
          heading: HeadingLevel.HEADING_1,
        });

        let children = [title];

        // 2) Znajdź tabelę (pierwsza .final-table)
        const tableElement = outputEl.querySelector(".final-table");
        if (!tableElement) {
          // Brak tabeli?
          return alert("Nie znaleziono tabeli w #output!");
        }

        // Tworzymy wiersze docx
        const tableRows = Array.from(tableElement.querySelectorAll("tr")).map(tr => {
          const cells = Array.from(tr.querySelectorAll("th,td")).map(td => {
            return new TableCell({
              children: [ new Paragraph(td.innerText || "") ]
            });
          });
          return new TableRow({ children: cells });
        });

        const docxTable = new Table({
          rows: tableRows
        });
        children.push(docxTable);

        // 3) Czy mamy wniosek urlopowy? (#vacationRequest)
        const vacationEl = document.getElementById("vacationRequest");
        if (vacationEl && vacationEl.innerHTML.trim()) {
          // Dodajemy Section z wnioskiem
          // Dla uproszczenia parse'ujemy tylko tekst, pomijając styl
          const lines = vacationEl.innerText.split("\n").map(s => s.trim()).filter(Boolean);
          children.push(new Paragraph({ text: "WNIOSEK URLOPOWY", heading: HeadingLevel.HEADING_2 }));

          lines.forEach(line => {
            children.push(new Paragraph(line));
          });
        }

        doc.addSection({ children });

        // 4) Generujemy blob
        const blob = await Packer.toBlob(doc);

        // Konwertujemy na base64
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result.split(",")[1];
          // Wysyłamy do /send-docx
          const res = await fetch("/send-docx", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, docxData: base64 })
          });
          if (res.ok) {
            alert("Wysłano DOCX na e-mail!");
          } else {
            alert("Błąd wysyłania Worda!");
          }
        };
        reader.readAsDataURL(blob);

      } catch (err) {
        console.error("Błąd w sendWord()", err);
        alert("Błąd: " + err);
      }
    }
  </script>
</body>
</html>
