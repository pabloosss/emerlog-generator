<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel Administratora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS + Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <div class="text-center">
      <h2>Panel Administratora</h2>
      <!-- Przycisk logowania admina -->
      <button id="adminPanelBtn" class="btn btn-warning mt-3">Zaloguj jako Admin</button>
      <!-- Przycisk powrotu na stronę główną -->
      <button id="goHomeBtn" class="btn btn-secondary mt-3">Powrót do strony głównej</button>
    </div>

    <!-- Miejsce na dynamiczny kod (formularze, tabele, itp.) -->
    <div id="output" class="mt-5"></div>
  </div>

  <!-- Modal logowania -->
  <div class="modal" id="adminModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Logowanie Admina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="adminLogin" class="form-control mb-2" placeholder="Login">
          <input type="password" id="adminPass" class="form-control mb-2" placeholder="Hasło">
          <button id="loginBtn" class="btn btn-primary">Zaloguj</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Referencje do globalnych zmiennych
    let allUsers = []; // tu trzymamy dane o użytkownikach (z /admin-data)

    // Obsługa przycisków
    document.getElementById("adminPanelBtn").addEventListener("click", () => {
      const modal = new bootstrap.Modal(document.getElementById("adminModal"));
      modal.show();
    });

    document.getElementById("goHomeBtn").addEventListener("click", () => {
      // Przykładowo przekierowanie na główną ("/"):
      window.location.href = "/";
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const login = document.getElementById("adminLogin").value.trim();
      const pass = document.getElementById("adminPass").value.trim();

      if (login === "ewa" && pass === "admin") {
        alert("Zalogowano jako admin");
        // Ukrywamy modal:
        document.getElementById("adminModal").classList.remove("show");
        document.querySelector(".modal-backdrop")?.remove();

        // Ładujemy panel admina (pobieramy listę i renderujemy)
        loadAdminPanel();
      } else {
        alert("Nieprawidłowy login lub hasło");
      }
    });

    // Funkcja do pobrania danych z serwera i narysowania panelu
    async function loadAdminPanel() {
      try {
        const res = await fetch("/admin-data");
        const data = await res.json();

        // Zapamiętujemy w zmiennej globalnej
        allUsers = data;

        // Rysujemy HTML panelu (filtry, sortowanie, tabela itd.)
        renderAdminPanel();
      } catch (err) {
        alert("Błąd przy pobieraniu /admin-data");
        console.error(err);
      }
    }

    function renderAdminPanel() {
      // Tutaj wstawiamy filtry / sortowanie / formularz dodawania
      // i tabelę z danymi
      let html = `
        <h3 class="mb-4">Lista użytkowników</h3>

        <!-- Formularz dodawania nowego użytkownika -->
        <form id="addUserForm" class="mb-4">
          <div class="row g-2">
            <div class="col-md-8">
              <input type="text" id="newUserName" class="form-control" placeholder="Imię i nazwisko" required>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-success w-100">Dodaj użytkownika</button>
            </div>
          </div>
        </form>

        <!-- Sekcja filtrów, wyszukiwania i sortowania -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="searchInput" class="form-label">Szukaj:</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Wpisz fragment imienia/nazwiska">
          </div>
          <div class="col-md-4">
            <label for="statusFilter" class="form-label">Filtr statusu:</label>
            <select id="statusFilter" class="form-select">
              <option value="all">Wszystko</option>
              <option value="sent">Wysłano</option>
              <option value="unsent">Nie wysłano</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="sortSelect" class="form-label">Sortowanie:</label>
            <select id="sortSelect" class="form-select">
              <option value="nameAsc">Nazwisko (A-Z)</option>
              <option value="nameDesc">Nazwisko (Z-A)</option>
              <option value="statusAsc">Status (Wysłano -> Nie wysłano)</option>
              <option value="statusDesc">Status (Nie wysłano -> Wysłano)</option>
            </select>
          </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
          <button id="resetBtn" class="btn btn-danger">Resetuj statusy</button>
        </div>

        <!-- Tabela -->
        <table class="table table-bordered" id="usersTable">
          <thead class="table-light">
            <tr>
              <th>Imię i nazwisko</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;

      document.getElementById("output").innerHTML = html;

      // Obsługa dodawania nowego użytkownika
      document.getElementById("addUserForm").addEventListener("submit", onAddUser);

      // Obsługa wyszukiwania
      document.getElementById("searchInput").addEventListener("input", renderUsersTable);

      // Obsługa filtrów i sortowania
      document.getElementById("statusFilter").addEventListener("change", renderUsersTable);
      document.getElementById("sortSelect").addEventListener("change", renderUsersTable);

      // Obsługa resetu statusów
      document.getElementById("resetBtn").addEventListener("click", onResetStatus);

      // Pierwsze wyświetlenie danych w tabeli
      renderUsersTable();
    }

    async function onAddUser(e) {
      e.preventDefault();
      const name = document.getElementById("newUserName").value.trim();
      if (!name) return alert("Podaj imię i nazwisko!");

      try {
        const res = await fetch("/add-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        if (res.ok) {
          alert("Użytkownik dodany!");
          loadAdminPanel(); // ponowne pobranie i odświeżenie
        } else {
          alert("Błąd przy dodawaniu użytkownika.");
        }
      } catch (err) {
        alert("Błąd fetch /add-user");
        console.error(err);
      }
    }

    async function onResetStatus() {
      if (!confirm("Na pewno zresetować statusy (z Wysłano na Nie wysłano)?")) return;
      try {
        // Domyślnie zakładamy, że istnieje endpoint /reset-status
        // Jeśli nie, możesz to załatwić lokalnie -> localResetStatus()
        const res = await fetch("/reset-status", { method: "POST" });
        if (res.ok) {
          alert("Statusy zresetowane!");
          loadAdminPanel();
        } else {
          alert("Błąd przy resetowaniu statusów.");
        }
      } catch (err) {
        alert("Błąd fetch /reset-status");
        console.error(err);
      }
    }

    function renderUsersTable() {
      // Pobieramy wybrane opcje z filtrów
      const filterVal = document.getElementById("statusFilter").value;
      const sortVal   = document.getElementById("sortSelect").value;
      const searchVal = document.getElementById("searchInput").value.trim().toLowerCase();

      // Kopia naszych danych
      let filtered = [...allUsers];

      // 1) Wyszukiwanie
      if (searchVal) {
        filtered = filtered.filter(u => u.name.toLowerCase().includes(searchVal));
      }

      // 2) Filtrowanie po statusie
      if (filterVal === "sent") {
        filtered = filtered.filter(u => u.sent);
      } else if (filterVal === "unsent") {
        filtered = filtered.filter(u => !u.sent);
      }
      // "all" - nie filtrujemy

      // 3) Sortowanie
      if (sortVal === "nameAsc") {
        filtered.sort((a, b) => a.name.localeCompare(b.name, "pl"));
      } else if (sortVal === "nameDesc") {
        filtered.sort((a, b) => b.name.localeCompare(a.name, "pl"));
      } else if (sortVal === "statusAsc") {
        // Porządkujemy tak, by "true" (wysłano) było najpierw
        filtered.sort((a, b) => {
          if (a.sent === b.sent) return 0;
          return a.sent ? -1 : 1; 
        });
      } else if (sortVal === "statusDesc") {
        // Odwrotnie
        filtered.sort((a, b) => {
          if (a.sent === b.sent) return 0;
          return a.sent ? 1 : -1;
        });
      }

      // Render do tabeli
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.name}</td>
          <td>${row.sent ? "Wysłano" : "Nie wysłano"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ================== ALTERNATYWNE: reset lokalny ==================
    // Jeśli nie masz /reset-status na serwerze, możesz to zrobić tak:
    // function localResetStatus() {
    //   allUsers.forEach(u => u.sent = false);
    //   renderUsersTable();
    // }

  </script>
</body>
</html>
