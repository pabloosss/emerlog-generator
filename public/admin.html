<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel Administratora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS + Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }
    .container {
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 1000px;
    }
    .text-center h2 {
      margin-bottom: 20px;
    }
    /* Tabela */
    table.table {
      margin-top: 20px;
    }
    /* Kolorowanie wierszy z wysłanym mailem – wiersze z sent = true będą wyświetlone jako "Wysłano", a te z false jako "Nie wysłano". */
    /* Dodatkowa kolumna Akcje z przyciskami usuwania */
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="text-center">
      <h2>Panel Administratora</h2>
      <!-- Przycisk logowania admina -->
      <button id="adminPanelBtn" class="btn btn-warning mt-3">Zaloguj jako Admin</button>
      <!-- Przycisk powrotu na stronę główną -->
      <button id="goHomeBtn" class="btn btn-secondary mt-3">Powrót do strony głównej</button>
    </div>

    <!-- Miejsce na dynamiczny kod (formularze, tabele, itp.) -->
    <div id="output" class="mt-5"></div>
  </div>

  <!-- Modal logowania -->
  <div class="modal" id="adminModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Logowanie Admina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="adminLogin" class="form-control mb-2" placeholder="Login">
          <input type="password" id="adminPass" class="form-control mb-2" placeholder="Hasło">
          <button id="loginBtn" class="btn btn-primary">Zaloguj</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Globalna zmienna – lista użytkowników
    let allUsers = []; // dane pobierane z /admin-data

    // Obsługa przycisków logowania i powrotu
    document.getElementById("adminPanelBtn").addEventListener("click", () => {
      const modal = new bootstrap.Modal(document.getElementById("adminModal"));
      modal.show();
    });

    document.getElementById("goHomeBtn").addEventListener("click", () => {
      window.location.href = "/";
    });

    // Logowanie admina
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const login = document.getElementById("adminLogin").value.trim();
      const pass = document.getElementById("adminPass").value.trim();

      if (login === "ewa" && pass === "admin") {
        alert("Zalogowano jako admin");
        // Ukrywamy modal
        document.getElementById("adminModal").classList.remove("show");
        document.querySelector(".modal-backdrop")?.remove();

        // Ładujemy panel admina
        loadAdminPanel();
      } else {
        alert("Nieprawidłowy login lub hasło");
      }
    });

    // Funkcja ładowania danych admina
    async function loadAdminPanel() {
      try {
        const res = await fetch("/admin-data");
        const data = await res.json();
        allUsers = data;
        renderAdminPanel();
      } catch (err) {
        alert("Błąd przy pobieraniu danych (/admin-data).");
        console.error(err);
      }
    }

    // Render panelu admina – formularz dodawania, filtry, wyszukiwanie, tabela
    function renderAdminPanel() {
      const html = `
        <h3 class="mb-4">Lista użytkowników</h3>
        <!-- Formularz dodawania nowego użytkownika -->
        <form id="addUserForm" class="mb-4">
          <div class="row g-2">
            <div class="col-md-8">
              <input type="text" id="newUserName" class="form-control" placeholder="Imię i nazwisko" required>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-success w-100">Dodaj użytkownika</button>
            </div>
          </div>
        </form>
        <!-- Sekcja filtrów, wyszukiwania i sortowania -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="searchInput" class="form-label">Szukaj:</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Wpisz fragment imienia/nazwiska">
          </div>
          <div class="col-md-4">
            <label for="statusFilter" class="form-label">Filtr statusu:</label>
            <select id="statusFilter" class="form-select">
              <option value="all">Wszystko</option>
              <option value="sent">Wysłano</option>
              <option value="unsent">Nie wysłano</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="sortSelect" class="form-label">Sortowanie:</label>
            <select id="sortSelect" class="form-select">
              <option value="nameAsc">Nazwisko (A-Z)</option>
              <option value="nameDesc">Nazwisko (Z-A)</option>
              <option value="statusAsc">Status (Wysłano -> Nie wysłano)</option>
              <option value="statusDesc">Status (Nie wysłano -> Wysłano)</option>
            </select>
          </div>
        </div>
        <div class="d-flex justify-content-end mb-3">
          <button id="resetBtn" class="btn btn-danger">Resetuj statusy</button>
        </div>
        <!-- Tabela z użytkownikami -->
        <table class="table table-bordered" id="usersTable">
          <thead class="table-light">
            <tr>
              <th>Imię i nazwisko</th>
              <th>Status</th>
              <th>Akcje</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      `;
      document.getElementById("output").innerHTML = html;

      // Obsługa formularza dodawania
      document.getElementById("addUserForm").addEventListener("submit", onAddUser);

      // Obsługa wyszukiwania
      document.getElementById("searchInput").addEventListener("input", renderUsersTable);

      // Obsługa filtrów i sortowania
      document.getElementById("statusFilter").addEventListener("change", renderUsersTable);
      document.getElementById("sortSelect").addEventListener("change", renderUsersTable);

      // Obsługa resetu statusów
      document.getElementById("resetBtn").addEventListener("click", onResetStatus);

      // Pierwsze wyświetlenie tabeli
      renderUsersTable();
    }

    // Dodawanie nowego użytkownika
    async function onAddUser(e) {
      e.preventDefault();
      const name = document.getElementById("newUserName").value.trim();
      if (!name) return alert("Podaj imię i nazwisko!");
      try {
        const res = await fetch("/add-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });
        if (res.ok) {
          alert("Użytkownik dodany!");
          loadAdminPanel();
        } else {
          alert("Błąd przy dodawaniu użytkownika.");
        }
      } catch (err) {
        alert("Błąd fetch /add-user");
        console.error(err);
      }
    }

    // Reset statusów – zmienia lokalnie dla wszystkich użytkowników property sent na false
    async function onResetStatus() {
      if (!confirm("Na pewno zresetować statusy (z Wysłano na Nie wysłano)?")) return;
      // Resetujemy lokalnie
      allUsers.forEach(u => u.sent = false);
      alert("Statusy zresetowane lokalnie!");
      renderUsersTable();
    }

    // Usuwanie użytkownika – zakładamy, że każdy użytkownik ma właściwość id
    async function onRemoveUser(userId) {
      if (!confirm("Na pewno usunąć tego użytkownika?")) return;
      try {
        const res = await fetch("/remove-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: userId })
        });
        if (res.ok) {
          alert("Użytkownik usunięty!");
          loadAdminPanel();
        } else {
          alert("Błąd przy usuwaniu użytkownika.");
        }
      } catch (err) {
        console.error(err);
        alert("Błąd fetch /remove-user");
      }
    }

    // Renderowanie tabeli użytkowników
    function renderUsersTable() {
      const filterVal = document.getElementById("statusFilter").value;
      const sortVal = document.getElementById("sortSelect").value;
      const searchVal = document.getElementById("searchInput").value.trim().toLowerCase();

      let filtered = [...allUsers];

      // Wyszukiwanie
      if (searchVal) {
        filtered = filtered.filter(u => u.name.toLowerCase().includes(searchVal));
      }

      // Filtrowanie statusu
      if (filterVal === "sent") {
        filtered = filtered.filter(u => u.sent);
      } else if (filterVal === "unsent") {
        filtered = filtered.filter(u => !u.sent);
      }

      // Sortowanie
      if (sortVal === "nameAsc") {
        filtered.sort((a, b) => a.name.localeCompare(b.name, "pl"));
      } else if (sortVal === "nameDesc") {
        filtered.sort((a, b) => b.name.localeCompare(a.name, "pl"));
      } else if (sortVal === "statusAsc") {
        filtered.sort((a, b) => {
          if (a.sent === b.sent) return 0;
          return a.sent ? -1 : 1;
        });
      } else if (sortVal === "statusDesc") {
        filtered.sort((a, b) => {
          if (a.sent === b.sent) return 0;
          return a.sent ? 1 : -1;
        });
      }

      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.name}</td>
          <td>${row.sent ? "Wysłano" : "Nie wysłano"}</td>
          <td><button class="btn btn-danger btn-sm" onclick="onRemoveUser('${row.id}')">Usuń</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Upewnij się, że funkcja onRemoveUser jest dostępna globalnie
    window.onRemoveUser = onRemoveUser;
  })();
</script>
</body>
</html>
